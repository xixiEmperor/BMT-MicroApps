import{u as e,d as a,a as l,b as s}from"./index-BuScbc3L.js";/* empty css                    *//* empty css                 */import{_ as t}from"./_plugin-vue_export-helper-CTKw_zaB.js";/* empty css                  */import{r as n,d as i,q as o,N as c,M as r,K as d,B as u,aZ as m,V as p,a3 as v,A as y,u as k,a_ as h,Q as f,a5 as w,a$ as g,b0 as _,Y as C,aL as I,O as T,au as b,aF as x,aC as L,a6 as V,a7 as j,E as U,z,aT as $,J as P}from"./element-plus-D8DMz00a.js";import{a as B,b as M,u as N,l as A,d as H,e as K,f as O,h as Q,i as q}from"./forum-CaX-pHs2.js";/* empty css                       *//* empty css                   */import{u as D}from"./forum-BBMbsy3N.js";import"./format-D0hGXpTN.js";const E={class:"post-detail-container"},F={key:0,class:"post-header"},G={class:"post-info"},J={class:"author-info"},Y={class:"author-detail"},Z={class:"author-name"},R={class:"publish-time"},S={class:"post-meta"},W={class:"view-count"},X={class:"delete-post"},ee={key:1,class:"post-content"},ae={class:"post-title"},le=["innerHTML"],se={class:"post-action-bar"},te={class:"comment-section"},ne={class:"comment-title"},ie={class:"comment-form"},oe={class:"comment-input-container"},ce={class:"comment-actions"},re={class:"word-count"},de={class:"comment-sort"},ue={class:"comment-list"},me={class:"comment-user"},pe={class:"comment-content"},ve={class:"comment-header"},ye={class:"comment-author"},ke={class:"comment-time"},he={class:"comment-text"},fe={class:"comment-footer"},we={class:"comment-actions"},ge=["onClick"],_e=["onClick"],Ce={class:"comment-delete-wrapper"},Ie=["onClick"],Te={key:0,class:"reply-form"},be={class:"reply-input-container"},xe={class:"reply-actions"},Le={class:"reply-word-count"},Ve={class:"reply-buttons"},je={key:1,class:"reply-list"},Ue={class:"reply-user"},ze={class:"reply-content"},$e={class:"reply-header"},Pe={class:"reply-author"},Be={class:"reply-time"},Me={class:"reply-text"},Ne={key:0,class:"reply-to"},Ae={class:"reply-footer"},He={class:"reply-actions"},Ke=["onClick"],Oe=["onClick"],Qe={class:"reply-delete-wrapper"},qe=["onClick"],De={key:0,class:"reply-form nested-reply-form"},Ee={class:"reply-input-container"},Fe={class:"reply-actions"},Ge={class:"reply-word-count"},Je={class:"reply-buttons"},Ye=["onClick"],Ze=t({__name:"PostDetail",setup(t){const Ze=a(),Re=l(),Se=e(),We=D();n().value=Se.userInfo;const Xe=i(()=>We.currentPost||{}),getPostDetailWithStore=async()=>{const e=Ze.params.id,a=await B(e);0===a.data.code?We.setCurrentPost(a.data.data):U.error(a.data.msg)};o(()=>{getPostDetailWithStore()});const ea=i(()=>We.comments||[]),aa=n("time_desc"),la=n("new"),getForumComments=async()=>{const e=Ze.params.id,a=await M(e,aa.value);0===a.data.code&&We.setComments(a.data.data)};o(()=>{getForumComments()});const sa=n(""),ta=i(()=>Xe.value&&void 0!==Xe.value.replyCount?Xe.value.replyCount:ea.value?ea.value.length:0),na=n({commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}),ia=n(!1),oa=n({}),ca=i(()=>ea.value?ea.value:[]),ra=i(()=>ia.value?ca.value:ca.value.slice(0,3)),likeComment=async e=>{if(!Se.token)return U.warning("请先登录后再点赞"),void Re.push("/login");try{const a=Ze.params.id,l=e.id;if(e.isLiked){const s=await H(a,l);0===s.data.code?(e.likes-=1,e.isLiked=!1,U.success("已取消点赞")):U.error(s.data.msg||"操作失败")}else{const s=await K(a,l);0===s.data.code?(e.likes+=1,e.isLiked=!0,U.success("点赞成功")):U.error(s.data.msg||"操作失败")}}catch(a){U.error("操作失败，请稍后重试")}},submitComment=async()=>{if(""!==sa.value.trim()){if(!Se.token)return U.warning("请先登录后再评论"),void Re.push("/login");try{const e=Ze.params.id,a=await q(e,{content:sa.value,parentId:null});0===a.data.code?(await getForumComments(),await getPostDetailWithStore(),sa.value="",U.success("评论发表成功"),s().publish(`post_comment_to_${Xe.value.author}`,`${Se.userinfo.username}评论了你的帖子`)):U.error(a.data.msg||"评论发表失败")}catch(e){U.error("评论发表失败，请稍后重试")}}else U.warning("评论内容不能为空")},deleteComment=(e,a=null)=>{P.confirm("确定要删除这条评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const l=Ze.params.id,s=e.id,t=await O(l,s);if(0===t.data.code){if(a){const l=a.children.findIndex(a=>a.id===e.id);-1!==l&&a.children.splice(l,1)}else await getForumComments();await getPostDetailWithStore(),U.success("删除成功")}else U.error(t.data.msg||"删除失败")}catch(l){U.error("删除失败，请稍后重试")}}).catch(()=>{})},showReplyBox=(e,a=null)=>{if(!Se.token)return U.warning("请先登录后再回复"),void Re.push("/login");let l=`回复 ${e.nickname}：`,s=null,t=null,n=e.userId;a?(s=a.id,t=e.id,n=e.userId,l=`回复 @${e.nickname}：`,oa.value={...oa.value,[a.id]:!0}):(s=e.id,t=null,n=e.userId),na.value={commentId:s,replyId:t,replyToUserId:n,content:"",placeholder:l}},cancelReply=()=>{na.value={commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}},submitReply=async()=>{if(na.value.content.trim())try{const e=Ze.params.id,a={content:na.value.content,parentId:na.value.commentId};na.value.replyId&&(a.replyToId=na.value.replyId),na.value.replyToUserId&&(a.replyToUserId=na.value.replyToUserId);const l=await q(e,a);0===l.data.code?(await getForumComments(),await getPostDetailWithStore(),na.value.commentId&&(oa.value={...oa.value,[na.value.commentId]:!0}),cancelReply(),U.success("回复成功")):U.error(l.data.msg||"回复失败")}catch(e){U.error("回复失败，请稍后重试")}else U.warning("回复内容不能为空")},toggleExpandComments=()=>{ia.value=!ia.value},changeSortType=e=>{aa.value="hot"===e?"likes":"new"===e?"time_desc":"old"===e?"time_asc":"time_desc",getForumComments()},likePost=async()=>{if(!Se.token)return U.warning("请先登录后再点赞"),void Re.push("/login");try{const e=Ze.params.id;if(Xe.value.isLiked){const a=await N(e);if(0===a.data.code){const e={...Xe.value,isLiked:!1,likes:Xe.value.likes-1};We.setCurrentPost(e),U.success("已取消点赞")}else U.error(a.data.msg||"操作失败")}else{const a=await A(e);if(0===a.data.code){const e={...Xe.value,isLiked:!0,likes:Xe.value.likes+1};We.setCurrentPost(e),s().publish(`post_like_to_${Xe.value.author}`,`${Se.userinfo.username}点赞了你的帖子`),U.success("点赞成功")}else U.error(a.data.msg||"操作失败")}}catch(e){U.error("操作失败，请稍后重试")}},deletePost=()=>{P.confirm("确定要删除这篇帖子吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=Ze.params.id,a=await Q(e);0===a.data.code?(U.success("帖子删除成功"),Re.push("/forum")):U.error(a.data.msg||"删除失败")}catch(e){U.error("删除失败，请稍后重试")}}).catch(()=>{})};return(e,a)=>{const l=m,s=f,t=T,n=b,i=x,o=L,U=_("auth");return z(),c("div",E,[Xe.value?(z(),c("div",F,[d("div",G,[d("div",J,[u(l,{size:40,src:Xe.value.authorAvatar,class:"author-avatar"},null,8,["src"]),d("div",Y,[d("div",Z,p(Xe.value.author),1),d("div",R,p(Xe.value.publishTime),1)])]),d("div",S,[d("div",W,[u(s,null,{default:y(()=>[u(k(h))]),_:1}),d("span",null,p(Xe.value.views)+" 次浏览",1)]),d("div",{class:w(["like-count",{"is-liked":Xe.value.isLiked}]),onClick:likePost},[u(s,null,{default:y(()=>[u(k(g))]),_:1}),d("span",null,p(Xe.value.likes)+" 点赞",1)],2),v((z(),c("div",X,[u(t,{type:"danger",size:"small",onClick:deletePost},{default:y(()=>[u(s,null,{default:y(()=>[u(k(I))]),_:1}),a[4]||(a[4]=C(" 删除帖子 ",-1))]),_:1})])),[[U,Xe.value.author]])])])])):r("",!0),Xe.value?(z(),c("div",ee,[d("h1",ae,p(Xe.value.title),1),d("div",{class:"content",innerHTML:Xe.value.content},null,8,le),d("div",se,[u(t,{type:"primary",plain:!Xe.value.isLiked,onClick:likePost,class:"like-button"},{default:y(()=>[u(s,null,{default:y(()=>[u(k(g))]),_:1}),C(" "+p(Xe.value.isLiked?"已点赞":"点赞")+" "+p(Xe.value.likes),1)]),_:1},8,["plain"])])])):r("",!0),d("div",te,[d("h3",ne,"评论 "+p(ta.value),1),d("div",ie,[d("div",oe,[u(n,{modelValue:sa.value,"onUpdate:modelValue":a[0]||(a[0]=e=>sa.value=e),type:"textarea",rows:"3",placeholder:"平等表达，友善交流",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),d("div",ce,[d("span",re,p(sa.value.length)+" / 1000",1),u(t,{type:"primary",onClick:submitComment},{default:y(()=>[...a[5]||(a[5]=[C("发送",-1)])]),_:1})])]),d("div",de,[u(o,{modelValue:la.value,"onUpdate:modelValue":a[1]||(a[1]=e=>la.value=e),onTabChange:changeSortType},{default:y(()=>[u(i,{label:"最热",name:"hot"}),u(i,{label:"最新",name:"new"}),u(i,{label:"最早",name:"old"})]),_:1},8,["modelValue"])]),d("div",ue,[(z(!0),c(V,null,j(ra.value,e=>(z(),c("div",{key:e.id,class:"comment-item"},[d("div",me,[u(l,{size:36,src:e.avatar},{default:y(()=>[C(p(e.nickname[0]),1)]),_:2},1032,["src"])]),d("div",pe,[d("div",ve,[d("span",ye,p(e.nickname),1),d("span",ke,p(e.replyTime),1)]),d("div",he,p(e.content),1),d("div",fe,[d("div",we,[d("span",{class:w(["comment-like",{"is-liked":e.isLiked}]),onClick:a=>likeComment(e)},[u(s,null,{default:y(()=>[u(k($))]),_:1}),C(" 点赞 "+p(e.likes),1)],10,ge),d("span",{class:"comment-reply",onClick:a=>showReplyBox(e)},"回复",8,_e)]),v((z(),c("div",Ce,[d("span",{class:"comment-delete",onClick:a=>deleteComment(e)},[u(s,null,{default:y(()=>[u(k(I))]),_:1}),a[6]||(a[6]=C(" 删除 ",-1))],8,Ie)])),[[U,e.nickname]])]),na.value.commentId!==e.id||na.value.replyId?r("",!0):(z(),c("div",Te,[d("div",be,[u(n,{modelValue:na.value.content,"onUpdate:modelValue":a[2]||(a[2]=e=>na.value.content=e),type:"textarea",rows:"2",placeholder:na.value.placeholder,maxlength:"500","show-word-limit":""},null,8,["modelValue","placeholder"])]),d("div",xe,[d("span",Le,p(na.value.content.length)+" / 500",1),d("div",Ve,[u(t,{size:"small",onClick:cancelReply},{default:y(()=>[...a[7]||(a[7]=[C("取消",-1)])]),_:1}),u(t,{size:"small",type:"primary",onClick:submitReply},{default:y(()=>[...a[8]||(a[8]=[C("回复",-1)])]),_:1})])])])),e.children&&e.children.length?(z(),c("div",je,[(z(!0),c(V,null,j(oa.value[e.id]?e.children:e.children.slice(0,3),i=>(z(),c("div",{key:i.id,class:"reply-item"},[d("div",Ue,[u(l,{size:30,src:i.avatar},{default:y(()=>[C(p(i.nickname[0]),1)]),_:2},1032,["src"])]),d("div",ze,[d("div",$e,[d("span",Pe,p(i.nickname),1),d("span",Be,p(i.replyTime),1)]),d("div",Me,[i.replyToNickname?(z(),c("span",Ne,"回复 @"+p(i.replyToNickname)+"：",1)):r("",!0),C(" "+p(i.content),1)]),d("div",Ae,[d("div",He,[d("span",{class:w(["reply-like",{"is-liked":i.isLiked}]),onClick:e=>likeComment(i)}," 点赞 "+p(i.likes),11,Ke),d("span",{class:"reply-button",onClick:a=>showReplyBox(i,e)},"回复",8,Oe)]),v((z(),c("div",Qe,[d("span",{class:"reply-delete",onClick:a=>deleteComment(i,e)},[u(s,null,{default:y(()=>[u(k(I))]),_:1}),a[9]||(a[9]=C(" 删除 ",-1))],8,qe)])),[[U,i.nickname]])]),na.value.commentId===e.id&&na.value.replyId===i.id?(z(),c("div",De,[d("div",Ee,[u(n,{modelValue:na.value.content,"onUpdate:modelValue":a[3]||(a[3]=e=>na.value.content=e),type:"textarea",rows:"2",placeholder:na.value.placeholder,maxlength:"500","show-word-limit":"",autofocus:""},null,8,["modelValue","placeholder"])]),d("div",Fe,[d("span",Ge,p(na.value.content.length)+" / 500",1),d("div",Je,[u(t,{size:"small",onClick:cancelReply},{default:y(()=>[...a[10]||(a[10]=[C("取消",-1)])]),_:1}),u(t,{size:"small",type:"primary",onClick:submitReply},{default:y(()=>[...a[11]||(a[11]=[C("回复",-1)])]),_:1})])])])):r("",!0)])]))),128)),e.children.length>3?(z(),c("div",{key:0,class:"view-more-replies",onClick:a=>{return l=e.id,void(oa.value={...oa.value,[l]:!oa.value[l]});var l}},p(oa.value[e.id]?"收起回复":`查看全部 ${e.children.length} 条回复`),9,Ye)):r("",!0)])):r("",!0)])]))),128)),ca.value.length>3?(z(),c("div",{key:0,class:"view-more-comments",onClick:toggleExpandComments},p(ia.value?"收起评论":`查看全部 ${ta.value} 条评论`),1)):r("",!0)])])])}}},[["__scopeId","data-v-48021ee2"]]);export{Ze as default};
