import{u as e,d as a,f as l,a as t,g as r}from"./index-BuScbc3L.js";/* empty css                *//* empty css                     */import{_ as o}from"./_plugin-vue_export-helper-CTKw_zaB.js";/* empty css                             *//* empty css                 *//* empty css                     *//* empty css               *//* empty css                  *//* empty css                    */import{r as s,a as n,q as d,N as u,K as i,B as c,A as p,aw as m,at as f,aU as v,au as h,u as g,T as b,aV as w,af as y,a6 as _,a7 as V,ao as U,S as j,aW as x,O as k,Y as R,aa as A,E,z as F,ae as z}from"./element-plus-D8DMz00a.js";const B={class:"user-center-container"},C=["src"],D={key:1,src:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png",class:"avatar",alt:"默认头像"},M={class:"form-section"},q={class:"form-section"},I=o({__name:"UserCenter",setup(o){const I=t(),L=a(),N=s("/"),O=e(),$=n({username:"",nickname:"",phone:"",bio:"",gender:"",birthday:"",location:"",avatar:""}),H=s(null),K=s(!1),P=[{value:"male",label:"男"},{value:"female",label:"女"},{value:"other",label:"其他"}],S=s(""),T={nickname:[{pattern:/^[\u4e00-\u9fa5a-zA-Z]+$/,message:"名称只能由英文字母，汉字组成",trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}]},beforeAvatarUpload=e=>{const a="image/jpeg"===e.type||"image/png"===e.type||"image/jpg"===e.type,l=e.size/1024/1024<10;return a?!!l||(E.error("头像大小不能超过 10MB!"),!1):(E.error("文件格式不支持，请上传jpg、png或jpeg格式图片"),!1)},handleAvatarSuccess=async(e,a)=>{var l,t;if(a.raw)try{const e=await((e,a=.8)=>new Promise(l=>{const t=new FileReader;t.readAsDataURL(e),t.onload=t=>{const r=new Image;r.src=t.target.result,r.onload=()=>{const t=document.createElement("canvas"),o=t.getContext("2d");let s=r.width,n=r.height;const d=800;s>n&&s>d?(n=Math.round(n*d/s),s=d):n>d&&(s=Math.round(s*d/n),n=d),t.width=s,t.height=n,o.clearRect(0,0,s,n),o.drawImage(r,0,0,s,n),t.toBlob(a=>{const t=new File([a],e.name,{type:e.type,lastModified:Date.now()});l(t)},e.type,a)}}}))(a.raw),l=new FormData;l.append("file",e);const t=new FileReader;t.readAsDataURL(e),t.onload=()=>{S.value=t.result};const o=await r(l);if(0===o.data.code){S.value=o.data.data.avatarUrl,$.avatar=o.data.data.avatarUrl;const e={...O.userinfo,avatar:o.data.data.avatarUrl};O.setUserinfo(e),window.dispatchEvent(new CustomEvent("user-avatar-updated",{detail:{avatarUrl:o.data.data.avatarUrl}})),E.success(o.data.message||"上传成功")}else E.error(o.data.message||"上传失败")}catch(o){E.error((null==(t=null==(l=o.response)?void 0:l.data)?void 0:t.message)||"头像上传失败")}},handleAvatarChange=e=>{e.raw&&beforeAvatarUpload(e.raw)&&handleAvatarSuccess(0,e)},saveUserInfo=async()=>{try{K.value=!0,await H.value.validate();const e=await l($);E.success(e.data.msg);const a={...O.userinfo,...e.data.data};O.setUserinfo(a),I.push(N.value)}catch(e){E.error(e.response.data.message)}finally{K.value=!1}};return d(()=>{(()=>{const e=O.userinfo;if(e)try{Object.keys($).forEach(a=>{e[a]&&($[a]=e[a])}),e.avatar&&(S.value=e.avatar)}catch(a){E.error(a.response.data.message)}if(L.query.from)N.value=L.query.from;else if(document.referrer&&document.referrer.includes(window.location.origin)){const e=new URL(document.referrer);N.value=e.pathname+e.search}})()}),(e,a)=>{const l=v,t=f,r=h,o=z,s=y,n=U,d=k,E=m,I=A;return F(),u("div",B,[a[11]||(a[11]=i("h2",null,"个人中心",-1)),c(I,{class:"user-center-card"},{default:p(()=>[c(E,{ref_key:"userFormRef",ref:H,model:$,rules:T,"label-position":"top",class:"user-form"},{default:p(()=>[c(t,{class:"avatar-uploader-container"},{default:p(()=>[c(l,{class:"avatar-uploader","show-file-list":!1,"on-change":handleAvatarChange,"before-upload":beforeAvatarUpload,"auto-upload":!1,name:"file"},{default:p(()=>[S.value?(F(),u("img",{key:0,src:S.value,class:"avatar"},null,8,C)):(F(),u("img",D)),a[7]||(a[7]=i("div",{class:"avatar-hover-text"},"点击更换头像",-1))]),_:1})]),_:1}),i("div",M,[a[8]||(a[8]=i("h3",null,"基本信息",-1)),c(t,{label:"账号"},{default:p(()=>[c(r,{modelValue:$.username,"onUpdate:modelValue":a[0]||(a[0]=e=>$.username=e),disabled:"",placeholder:"userinfo.username"},null,8,["modelValue"])]),_:1}),c(t,{label:"昵称",prop:"nickname"},{default:p(()=>[c(r,{modelValue:$.nickname,"onUpdate:modelValue":a[1]||(a[1]=e=>$.nickname=e),placeholder:"请输入昵称","prefix-icon":g(b)},null,8,["modelValue","prefix-icon"])]),_:1}),c(t,{label:"手机号码",prop:"phone"},{default:p(()=>[c(r,{modelValue:$.phone,"onUpdate:modelValue":a[2]||(a[2]=e=>$.phone=e),placeholder:"请输入手机号码","prefix-icon":g(w)},null,8,["modelValue","prefix-icon"])]),_:1}),c(t,{label:"个人简介"},{default:p(()=>[c(r,{modelValue:$.bio,"onUpdate:modelValue":a[3]||(a[3]=e=>$.bio=e),type:"textarea",placeholder:"请输入个人简介",rows:4},null,8,["modelValue"])]),_:1})]),i("div",q,[a[9]||(a[9]=i("h3",null,"更多信息",-1)),c(t,{label:"性别"},{default:p(()=>[c(s,{modelValue:$.gender,"onUpdate:modelValue":a[4]||(a[4]=e=>$.gender=e),placeholder:"请选择性别",style:{width:"100%"}},{default:p(()=>[(F(),u(_,null,V(P,e=>c(o,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),c(t,{label:"生日"},{default:p(()=>[c(n,{modelValue:$.birthday,"onUpdate:modelValue":a[5]||(a[5]=e=>$.birthday=e),type:"date",placeholder:"请选择生日",style:{width:"100%"},"prefix-icon":g(j)},null,8,["modelValue","prefix-icon"])]),_:1}),c(t,{label:"所在地"},{default:p(()=>[c(r,{modelValue:$.location,"onUpdate:modelValue":a[6]||(a[6]=e=>$.location=e),placeholder:"请输入所在地","prefix-icon":g(x)},null,8,["modelValue","prefix-icon"])]),_:1})]),c(t,null,{default:p(()=>[c(d,{type:"primary",onClick:saveUserInfo,loading:K.value,class:"save-btn"},{default:p(()=>[...a[10]||(a[10]=[R("保存修改",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})])}}},[["__scopeId","data-v-1c0e85da"]]);export{I as default};
