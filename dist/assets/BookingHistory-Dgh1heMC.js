import{r as a,L as e,o as t,l,h as s,g as o,M as r,w as u,ae as i,a0 as n,$ as d,ah as c,a1 as v,f as m,k as p,au as f,a4 as b,A as y,x as w,m as g,a3 as k,aP as _,aQ as h,a5 as j,E as x,a as C,c as T,at as N,J as D,a2 as z}from"./index-BMm2wflY.js";/* empty css                   */import{g as A,O as H,a as P,b as V,d as $,e as B}from"./venueOrder-KIm4tj_0.js";/* empty css                   *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";import{_ as I}from"./_plugin-vue_export-helper-CTKw_zaB.js";/* empty css                 *//* empty css                     *//* empty css                       */const M={class:"booking-history"},S={class:"container"},E={class:"filter-section"},L={class:"table-container"},O={key:2,class:"pagination"},U={key:0,class:"booking-detail"},q={class:"dialog-footer"},J=I({__name:"BookingHistory",setup(I){const J=C(),Q=a(!1),F=a({status:""});e(()=>F.value.status,a=>{fetchMyOrders(a)});const G=a(1),K=a(10),R=a(0),W=a([]),X=a(!1),Y=a(null),fetchMyOrders=async a=>{try{Q.value=!0;const e=await A(a);0===e.data.code?(W.value=e.data.data.list||[],R.value=e.data.data.total):x.error(e.message||"获取订单列表失败")}catch(e){x.error("获取订单列表失败，请稍后重试")}finally{Q.value=!1}},handlePageChange=a=>{G.value=a},isBookingExpired=a=>{if(!a)return!0;const e=new Date;e.setHours(0,0,0,0);const t=new Date(a.date);return t.setHours(0,0,0,0),t<e},canCancel=a=>!!a&&("reserved"===a.status||1===a.status),getCancelButtonText=a=>a&&("cancelled"===a.status||4===a.status)?"已取消":"取消预订",getStatusText=a=>P[a]||a,getStatusTagType=a=>H[a]||"",cancelBooking=async a=>{try{await T.confirm(`确定要取消 ${a.reservationDate} ${a.timeSlot} ${a.venueName} 的预订吗？取消后无法恢复。`,"取消预订",{confirmButtonText:"确定",cancelButtonText:"返回",type:"warning"}),Q.value=!0;const e=await $(a.id,{reason:"用户主动取消"});0===e.data.code?(x.success(e.data.data),await fetchMyOrders()):x.error(e.message||"取消预订失败")}catch(e){"cancel"===e?x.info("已取消操作"):x.error("取消预订失败，请稍后重试")}finally{Q.value=!1}},cancelBookingFromDetail=async()=>{Y.value&&(await cancelBooking(Y.value),X.value=!1)},handleRefund=async a=>{try{await T.confirm("确定要申请退款吗？退款申请提交后需要管理员审核,并需要到线下退款。","申请退款",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),Q.value=!0;const e=await B(a.id,{reason:"用户申请退款"});0===e.data.code?(x.success("退款申请已提交，等待管理员审核"),await fetchMyOrders()):x.error(e.message||"申请退款失败")}catch(e){"cancel"===e?x.info("已取消操作"):x.error("申请退款失败，请稍后重试")}finally{Q.value=!1}};return t(()=>{fetchMyOrders()}),(a,e)=>{const t=d,C=n,T=i,A=c,H=z,P=f,$=b,B=g,I=N,Z=k,aa=h,ea=_,ta=j,la=v;return D(),l("div",M,[s("div",S,[e[7]||(e[7]=s("h2",{class:"page-title"},"我的预订记录",-1)),s("div",E,[o(A,{inline:!0,model:F.value},{default:u(()=>[o(T,{label:"预订状态"},{default:u(()=>[o(C,{modelValue:F.value.status,"onUpdate:modelValue":e[0]||(e[0]=a=>F.value.status=a),placeholder:"预订状态",clearable:"",style:{width:"120px"}},{default:u(()=>[o(t,{label:"全部",value:""}),o(t,{label:"待支付",value:"1"}),o(t,{label:"已支付",value:"2"}),o(t,{label:"已完成",value:"3"}),o(t,{label:"已取消",value:"4"}),o(t,{label:"已退款",value:"5"}),o(t,{label:"退款中",value:"6"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),r((D(),l("div",L,[0!==W.value.length||Q.value?(D(),m(I,{key:1,data:W.value,style:{width:"100%"},border:""},{default:u(()=>[o(P,{prop:"id",label:"预订号",width:"80"}),o(P,{prop:"venueName",label:"场地名称",width:"120"}),o(P,{prop:"reservationDate",label:"预订日期",width:"120"}),o(P,{prop:"timeSlot",label:"时间段",width:"120"}),o(P,{prop:"totalAmount",label:"金额(元)",width:"100"}),o(P,{prop:"status",label:"状态",width:"120"},{default:u(a=>[o($,{type:getStatusTagType(a.row.status)},{default:u(()=>[y(w(getStatusText(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),o(P,{prop:"createTime",label:"预订时间",width:"160"}),o(P,{label:"操作",fixed:"right",width:"300"},{default:u(a=>[o(B,{type:"primary",size:"small",onClick:e=>(async a=>{try{Q.value=!0;const e=await V(a.id);0===e.data.code?(Y.value=e.data.data,Y.value.contactName=e.data.data.remark.split(" ")[0],Y.value.contactPhone=e.data.data.remark.split(" ")[1],X.value=!0):x.error(e.message||"获取订单详情失败")}catch(e){x.error("获取订单详情失败，请稍后重试")}finally{Q.value=!1}})(a.row)},{default:u(()=>[...e[4]||(e[4]=[y(" 查看详情 ",-1)])]),_:1},8,["onClick"]),1===a.row.status?(D(),m(B,{key:0,type:"success",size:"small",onClick:e=>(async a=>{const e=a.remark,[t,l,s]=e.split(" ");J.push({path:"/payment",query:{orderNo:a.orderNo},state:{booking:{id:a.id,venueName:a.venueName,venueId:a.venueId,reservationDate:a.reservationDate,startTime:a.startTime,endTime:a.endTime,duration:a.duration,contactName:t,contactPhone:l,remarkMessage:s,pricePerHour:a.pricePerHour,totalAmount:a.totalAmount,createTime:a.createTime}}})})(a.row)},{default:u(()=>[...e[5]||(e[5]=[y(" 立即支付 ",-1)])]),_:1},8,["onClick"])):p("",!0),1===a.row.status?(D(),m(B,{key:1,type:"danger",size:"small",onClick:e=>cancelBooking(a.row),disabled:isBookingExpired(a.row)||!canCancel(a.row)},{default:u(()=>[y(w(getCancelButtonText(a.row)),1)]),_:2},1032,["onClick","disabled"])):p("",!0),2===a.row.status?(D(),m(B,{key:2,type:"warning",size:"small",onClick:e=>handleRefund(a.row),disabled:2!==a.row.status},{default:u(()=>[...e[6]||(e[6]=[y(" 申请退款 ",-1)])]),_:1},8,["onClick","disabled"])):p("",!0)]),_:1})]),_:1},8,["data"])):(D(),m(H,{key:0,description:"暂无预订记录"})),W.value.length>0?(D(),l("div",O,[o(Z,{background:"",layout:"prev, pager, next, total",total:R.value,"page-size":K.value,"current-page":G.value,onCurrentChange:handlePageChange},null,8,["total","page-size","current-page"])])):p("",!0)])),[[la,Q.value]])]),o(ta,{title:"预订详情",modelValue:X.value,"onUpdate:modelValue":e[3]||(e[3]=a=>X.value=a),width:"500px",center:""},{footer:u(()=>[s("span",q,[o(B,{onClick:e[1]||(e[1]=a=>X.value=!1)},{default:u(()=>[...e[8]||(e[8]=[y("关闭",-1)])]),_:1}),Y.value&&canCancel(Y.value)?(D(),m(B,{key:0,type:"danger",onClick:cancelBookingFromDetail,disabled:isBookingExpired(Y.value)||!canCancel(Y.value)},{default:u(()=>[y(w(getCancelButtonText(Y.value)),1)]),_:1},8,["disabled"])):p("",!0),!Y.value||1!==Y.value.status&&"reserved"!==Y.value.status?p("",!0):(D(),m(B,{key:1,type:"warning",onClick:e[2]||(e[2]=a=>handleRefund(Y.value))},{default:u(()=>[...e[9]||(e[9]=[y(" 申请退款 ",-1)])]),_:1}))])]),default:u(()=>[Y.value?(D(),l("div",U,[o(ea,{column:1,border:!0},{default:u(()=>[o(aa,{label:"预订编号"},{default:u(()=>[y(w(Y.value.id),1)]),_:1}),Y.value.orderNo?(D(),m(aa,{key:0,label:"订单号"},{default:u(()=>[y(w(Y.value.orderNo),1)]),_:1})):p("",!0),o(aa,{label:"场地名称"},{default:u(()=>[y(w(Y.value.courtName||Y.value.venueName),1)]),_:1}),o(aa,{label:"预订日期"},{default:u(()=>[y(w(Y.value.date||Y.value.reservationDate),1)]),_:1}),o(aa,{label:"预订时段"},{default:u(()=>[y(w(Y.value.timeSlot||`${Y.value.startTime}-${Y.value.endTime}`),1)]),_:1}),o(aa,{label:"预订价格"},{default:u(()=>[y(w(Y.value.price||Y.value.totalAmount)+" 元",1)]),_:1}),o(aa,{label:"预订状态"},{default:u(()=>[o($,{type:getStatusTagType(Y.value.status)},{default:u(()=>[y(w(getStatusText(Y.value.status)),1)]),_:1},8,["type"])]),_:1}),o(aa,{label:"预订人"},{default:u(()=>[y(w(Y.value.contactName),1)]),_:1}),o(aa,{label:"联系电话"},{default:u(()=>[y(w(Y.value.contactPhone),1)]),_:1}),o(aa,{label:"预订时间"},{default:u(()=>[y(w(Y.value.createTime||Y.value.createdAt),1)]),_:1}),Y.value.remark||Y.value.note?(D(),m(aa,{key:1,label:"备注"},{default:u(()=>[y(w(Y.value.remark.split(" ")[2]),1)]),_:1})):p("",!0)]),_:1})])):p("",!0)]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-edab4659"]]);export{J as default};
