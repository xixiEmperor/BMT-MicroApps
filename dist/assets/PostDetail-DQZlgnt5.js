import{u as e,r as a,d as l,o as s,l as t,k as n,h as i,g as o,aS as c,x as r,M as d,w as u,j as m,aT as p,p as v,O as y,aU as k,aV as h,A as f,ay as w,m as g,af as _,as as C,ap as I,P as T,Q as x,an as b,E as L,a as V,Z as j,J as U,aJ as z,c as $}from"./index-BMm2wflY.js";/* empty css                    *//* empty css                 */import{_ as P}from"./_plugin-vue_export-helper-CTKw_zaB.js";/* empty css                  */import{a as B,b as M,u as A,l as H,d as J,e as N,f as Q,h as D,i as E}from"./forum-kHVTcl2q.js";/* empty css                       *//* empty css                   */import{u as G}from"./forum-BtzwW1DJ.js";import"./format-D0hGXpTN.js";const K={class:"post-detail-container"},O={key:0,class:"post-header"},R={class:"post-info"},S={class:"author-info"},Z={class:"author-detail"},q={class:"author-name"},F={class:"publish-time"},W={class:"post-meta"},X={class:"view-count"},Y={class:"delete-post"},ee={key:1,class:"post-content"},ae={class:"post-title"},le=["innerHTML"],se={class:"post-action-bar"},te={class:"comment-section"},ne={class:"comment-title"},ie={class:"comment-form"},oe={class:"comment-input-container"},ce={class:"comment-actions"},re={class:"word-count"},de={class:"comment-sort"},ue={class:"comment-list"},me={class:"comment-user"},pe={class:"comment-content"},ve={class:"comment-header"},ye={class:"comment-author"},ke={class:"comment-time"},he={class:"comment-text"},fe={class:"comment-footer"},we={class:"comment-actions"},ge=["onClick"],_e=["onClick"],Ce={class:"comment-delete-wrapper"},Ie=["onClick"],Te={key:0,class:"reply-form"},xe={class:"reply-input-container"},be={class:"reply-actions"},Le={class:"reply-word-count"},Ve={class:"reply-buttons"},je={key:1,class:"reply-list"},Ue={class:"reply-user"},ze={class:"reply-content"},$e={class:"reply-header"},Pe={class:"reply-author"},Be={class:"reply-time"},Me={class:"reply-text"},Ae={key:0,class:"reply-to"},He={class:"reply-footer"},Je={class:"reply-actions"},Ne=["onClick"],Qe=["onClick"],De={class:"reply-delete-wrapper"},Ee=["onClick"],Ge={key:0,class:"reply-form nested-reply-form"},Ke={class:"reply-input-container"},Oe={class:"reply-actions"},Re={class:"reply-word-count"},Se={class:"reply-buttons"},Ze=["onClick"],qe=P({__name:"PostDetail",setup(P){const qe=b(),Fe=V(),We=e(),Xe=G();a().value=We.userInfo;const Ye=l(()=>Xe.currentPost||{}),getPostDetailWithStore=async()=>{const e=qe.params.id,a=await B(e);0===a.data.code?Xe.setCurrentPost(a.data.data):L.error(a.data.msg)};s(()=>{getPostDetailWithStore()});const ea=l(()=>Xe.comments||[]),aa=a("time_desc"),la=a("new"),getForumComments=async()=>{const e=qe.params.id,a=await M(e,aa.value);0===a.data.code&&Xe.setComments(a.data.data)};s(()=>{getForumComments()});const sa=a(""),ta=l(()=>Ye.value&&void 0!==Ye.value.replyCount?Ye.value.replyCount:ea.value?ea.value.length:0),na=a({commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}),ia=a(!1),oa=a({}),ca=l(()=>ea.value?ea.value:[]),ra=l(()=>ia.value?ca.value:ca.value.slice(0,3)),likeComment=async e=>{if(!We.token)return L.warning("请先登录后再点赞"),void Fe.push("/login");try{const a=qe.params.id,l=e.id;if(e.isLiked){const s=await J(a,l);0===s.data.code?(e.likes-=1,e.isLiked=!1,L.success("已取消点赞")):L.error(s.data.msg||"操作失败")}else{const s=await N(a,l);0===s.data.code?(e.likes+=1,e.isLiked=!0,L.success("点赞成功")):L.error(s.data.msg||"操作失败")}}catch(a){L.error("操作失败，请稍后重试")}},submitComment=async()=>{if(""!==sa.value.trim()){if(!We.token)return L.warning("请先登录后再评论"),void Fe.push("/login");try{const e=qe.params.id,a=await E(e,{content:sa.value,parentId:null});0===a.data.code?(await getForumComments(),await getPostDetailWithStore(),sa.value="",L.success("评论发表成功"),j().publish(`post_comment_to_${Ye.value.author}`,`${We.userinfo.username}评论了你的帖子`)):L.error(a.data.msg||"评论发表失败")}catch(e){L.error("评论发表失败，请稍后重试")}}else L.warning("评论内容不能为空")},deleteComment=(e,a=null)=>{$.confirm("确定要删除这条评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const l=qe.params.id,s=e.id,t=await Q(l,s);if(0===t.data.code){if(a){const l=a.children.findIndex(a=>a.id===e.id);-1!==l&&a.children.splice(l,1)}else await getForumComments();await getPostDetailWithStore(),L.success("删除成功")}else L.error(t.data.msg||"删除失败")}catch(l){L.error("删除失败，请稍后重试")}}).catch(()=>{})},showReplyBox=(e,a=null)=>{if(!We.token)return L.warning("请先登录后再回复"),void Fe.push("/login");let l=`回复 ${e.nickname}：`,s=null,t=null,n=e.userId;a?(s=a.id,t=e.id,n=e.userId,l=`回复 @${e.nickname}：`,oa.value={...oa.value,[a.id]:!0}):(s=e.id,t=null,n=e.userId),na.value={commentId:s,replyId:t,replyToUserId:n,content:"",placeholder:l}},cancelReply=()=>{na.value={commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}},submitReply=async()=>{if(na.value.content.trim())try{const e=qe.params.id,a={content:na.value.content,parentId:na.value.commentId};na.value.replyId&&(a.replyToId=na.value.replyId),na.value.replyToUserId&&(a.replyToUserId=na.value.replyToUserId);const l=await E(e,a);0===l.data.code?(await getForumComments(),await getPostDetailWithStore(),na.value.commentId&&(oa.value={...oa.value,[na.value.commentId]:!0}),cancelReply(),L.success("回复成功")):L.error(l.data.msg||"回复失败")}catch(e){L.error("回复失败，请稍后重试")}else L.warning("回复内容不能为空")},toggleExpandComments=()=>{ia.value=!ia.value},changeSortType=e=>{aa.value="hot"===e?"likes":"new"===e?"time_desc":"old"===e?"time_asc":"time_desc",getForumComments()},likePost=async()=>{if(!We.token)return L.warning("请先登录后再点赞"),void Fe.push("/login");try{const e=qe.params.id;if(Ye.value.isLiked){const a=await A(e);if(0===a.data.code){const e={...Ye.value,isLiked:!1,likes:Ye.value.likes-1};Xe.setCurrentPost(e),L.success("已取消点赞")}else L.error(a.data.msg||"操作失败")}else{const a=await H(e);if(0===a.data.code){const e={...Ye.value,isLiked:!0,likes:Ye.value.likes+1};Xe.setCurrentPost(e),j().publish(`post_like_to_${Ye.value.author}`,`${We.userinfo.username}点赞了你的帖子`),L.success("点赞成功")}else L.error(a.data.msg||"操作失败")}}catch(e){L.error("操作失败，请稍后重试")}},deletePost=()=>{$.confirm("确定要删除这篇帖子吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=qe.params.id,a=await D(e);0===a.data.code?(L.success("帖子删除成功"),Fe.push("/forum")):L.error(a.data.msg||"删除失败")}catch(e){L.error("删除失败，请稍后重试")}}).catch(()=>{})};return(e,a)=>{const l=c,s=v,b=g,L=_,V=C,j=I,$=h("auth");return U(),t("div",K,[Ye.value?(U(),t("div",O,[i("div",R,[i("div",S,[o(l,{size:40,src:Ye.value.authorAvatar,class:"author-avatar"},null,8,["src"]),i("div",Z,[i("div",q,r(Ye.value.author),1),i("div",F,r(Ye.value.publishTime),1)])]),i("div",W,[i("div",X,[o(s,null,{default:u(()=>[o(m(p))]),_:1}),i("span",null,r(Ye.value.views)+" 次浏览",1)]),i("div",{class:y(["like-count",{"is-liked":Ye.value.isLiked}]),onClick:likePost},[o(s,null,{default:u(()=>[o(m(k))]),_:1}),i("span",null,r(Ye.value.likes)+" 点赞",1)],2),d((U(),t("div",Y,[o(b,{type:"danger",size:"small",onClick:deletePost},{default:u(()=>[o(s,null,{default:u(()=>[o(m(w))]),_:1}),a[4]||(a[4]=f(" 删除帖子 ",-1))]),_:1})])),[[$,Ye.value.author]])])])])):n("",!0),Ye.value?(U(),t("div",ee,[i("h1",ae,r(Ye.value.title),1),i("div",{class:"content",innerHTML:Ye.value.content},null,8,le),i("div",se,[o(b,{type:"primary",plain:!Ye.value.isLiked,onClick:likePost,class:"like-button"},{default:u(()=>[o(s,null,{default:u(()=>[o(m(k))]),_:1}),f(" "+r(Ye.value.isLiked?"已点赞":"点赞")+" "+r(Ye.value.likes),1)]),_:1},8,["plain"])])])):n("",!0),i("div",te,[i("h3",ne,"评论 "+r(ta.value),1),i("div",ie,[i("div",oe,[o(L,{modelValue:sa.value,"onUpdate:modelValue":a[0]||(a[0]=e=>sa.value=e),type:"textarea",rows:"3",placeholder:"平等表达，友善交流",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),i("div",ce,[i("span",re,r(sa.value.length)+" / 1000",1),o(b,{type:"primary",onClick:submitComment},{default:u(()=>[...a[5]||(a[5]=[f("发送",-1)])]),_:1})])]),i("div",de,[o(j,{modelValue:la.value,"onUpdate:modelValue":a[1]||(a[1]=e=>la.value=e),onTabChange:changeSortType},{default:u(()=>[o(V,{label:"最热",name:"hot"}),o(V,{label:"最新",name:"new"}),o(V,{label:"最早",name:"old"})]),_:1},8,["modelValue"])]),i("div",ue,[(U(!0),t(T,null,x(ra.value,e=>(U(),t("div",{key:e.id,class:"comment-item"},[i("div",me,[o(l,{size:36,src:e.avatar},{default:u(()=>[f(r(e.nickname[0]),1)]),_:2},1032,["src"])]),i("div",pe,[i("div",ve,[i("span",ye,r(e.nickname),1),i("span",ke,r(e.replyTime),1)]),i("div",he,r(e.content),1),i("div",fe,[i("div",we,[i("span",{class:y(["comment-like",{"is-liked":e.isLiked}]),onClick:a=>likeComment(e)},[o(s,null,{default:u(()=>[o(m(z))]),_:1}),f(" 点赞 "+r(e.likes),1)],10,ge),i("span",{class:"comment-reply",onClick:a=>showReplyBox(e)},"回复",8,_e)]),d((U(),t("div",Ce,[i("span",{class:"comment-delete",onClick:a=>deleteComment(e)},[o(s,null,{default:u(()=>[o(m(w))]),_:1}),a[6]||(a[6]=f(" 删除 ",-1))],8,Ie)])),[[$,e.nickname]])]),na.value.commentId!==e.id||na.value.replyId?n("",!0):(U(),t("div",Te,[i("div",xe,[o(L,{modelValue:na.value.content,"onUpdate:modelValue":a[2]||(a[2]=e=>na.value.content=e),type:"textarea",rows:"2",placeholder:na.value.placeholder,maxlength:"500","show-word-limit":""},null,8,["modelValue","placeholder"])]),i("div",be,[i("span",Le,r(na.value.content.length)+" / 500",1),i("div",Ve,[o(b,{size:"small",onClick:cancelReply},{default:u(()=>[...a[7]||(a[7]=[f("取消",-1)])]),_:1}),o(b,{size:"small",type:"primary",onClick:submitReply},{default:u(()=>[...a[8]||(a[8]=[f("回复",-1)])]),_:1})])])])),e.children&&e.children.length?(U(),t("div",je,[(U(!0),t(T,null,x(oa.value[e.id]?e.children:e.children.slice(0,3),c=>(U(),t("div",{key:c.id,class:"reply-item"},[i("div",Ue,[o(l,{size:30,src:c.avatar},{default:u(()=>[f(r(c.nickname[0]),1)]),_:2},1032,["src"])]),i("div",ze,[i("div",$e,[i("span",Pe,r(c.nickname),1),i("span",Be,r(c.replyTime),1)]),i("div",Me,[c.replyToNickname?(U(),t("span",Ae,"回复 @"+r(c.replyToNickname)+"：",1)):n("",!0),f(" "+r(c.content),1)]),i("div",He,[i("div",Je,[i("span",{class:y(["reply-like",{"is-liked":c.isLiked}]),onClick:e=>likeComment(c)}," 点赞 "+r(c.likes),11,Ne),i("span",{class:"reply-button",onClick:a=>showReplyBox(c,e)},"回复",8,Qe)]),d((U(),t("div",De,[i("span",{class:"reply-delete",onClick:a=>deleteComment(c,e)},[o(s,null,{default:u(()=>[o(m(w))]),_:1}),a[9]||(a[9]=f(" 删除 ",-1))],8,Ee)])),[[$,c.nickname]])]),na.value.commentId===e.id&&na.value.replyId===c.id?(U(),t("div",Ge,[i("div",Ke,[o(L,{modelValue:na.value.content,"onUpdate:modelValue":a[3]||(a[3]=e=>na.value.content=e),type:"textarea",rows:"2",placeholder:na.value.placeholder,maxlength:"500","show-word-limit":"",autofocus:""},null,8,["modelValue","placeholder"])]),i("div",Oe,[i("span",Re,r(na.value.content.length)+" / 500",1),i("div",Se,[o(b,{size:"small",onClick:cancelReply},{default:u(()=>[...a[10]||(a[10]=[f("取消",-1)])]),_:1}),o(b,{size:"small",type:"primary",onClick:submitReply},{default:u(()=>[...a[11]||(a[11]=[f("回复",-1)])]),_:1})])])])):n("",!0)])]))),128)),e.children.length>3?(U(),t("div",{key:0,class:"view-more-replies",onClick:a=>{return l=e.id,void(oa.value={...oa.value,[l]:!oa.value[l]});var l}},r(oa.value[e.id]?"收起回复":`查看全部 ${e.children.length} 条回复`),9,Ze)):n("",!0)])):n("",!0)])]))),128)),ca.value.length>3?(U(),t("div",{key:0,class:"view-more-comments",onClick:toggleExpandComments},r(ia.value?"收起评论":`查看全部 ${ta.value} 条评论`),1)):n("",!0)])])])}}},[["__scopeId","data-v-48021ee2"]]);export{qe as default};
