import{i as e,b as a,a as t}from"./index-BuScbc3L.js";import{c as l}from"./venueOrder-qXvr7p9X.js";/* empty css                   *//* empty css               *//* empty css                *//* empty css                         *//* empty css               *//* empty css                  *//* empty css                     */import{_ as s}from"./_plugin-vue_export-helper-CTKw_zaB.js";/* empty css                             *//* empty css                 *//* empty css                   *//* empty css                      *//* empty css                 *//* empty css                         */import{r as i,a as n,q as o,D as r,N as u,K as c,a3 as d,M as v,B as m,A as p,ae as g,af as y,ag as f,y as b,a6 as h,a7 as k,ah as _,ai as w,aj as V,Y as D,V as S,ak as x,E as T,al as C,z as $,am as N,a5 as j,O as z,an as H,d as Y,w as O,ao as P,ap as M,u as U,aq as R,Q as I,ar as E,S as q,as as A,at as F,au as B,av as G,aw as K,ax as L,ay as Q,az as Z,aa as J}from"./element-plus-D8DMz00a.js";import{f as W}from"./format-D0hGXpTN.js";/* empty css                     *//* empty css                 */const X={class:"notice-list-page"},ee={class:"filter-container"},ae={class:"notice-carousel-container"},te={class:"notice-header"},le={class:"notice-title"},se={class:"notice-meta"},ie={class:"notice-time"},ne={class:"notice-content"},oe={class:"notice-footer"},re={key:1,class:"empty-state"},ue={key:0,class:"notice-grid"},ce={class:"notice-grid-container"},de=["onClick"],ve={class:"grid-item-header"},me={class:"grid-item-title"},pe={class:"grid-item-time"},ge={key:1,class:"pagination-container"},ye={class:"notice-detail"},fe={class:"detail-meta"},be={class:"detail-time"},he={class:"detail-content"},ke=s({__name:"NoticeList",setup(t){const l=i(null),s=i(!1),Y=i(1),O=i(5),P=i(0),M=i([]),U=i(!1),R=n({id:"",title:"",content:"",type:1,publishTime:""}),getTypeTag=e=>({1:"",2:"warning"}[e]||""),getTypeText=e=>({1:"普通通知",2:"重要通知"}[e]||"未知"),formatTime=e=>W(e,"YYYY-MM-DD HH:mm"),truncateContent=(e,a=100)=>e?e.length>a?e.substring(0,a)+"...":e:"",fetchNoticeList=async()=>{try{s.value=!0;const a=await function(a={}){return e({url:"/api/reservation/notice",method:"get",params:{pageNum:a.pageNum||1,pageSize:a.pageSize||10,type:a.type||null}})}({pageNum:Y.value,pageSize:O.value,type:l.value});0===a.data.code?(M.value=a.data.data.list,P.value=a.data.data.total):T.error(a.data.msg||"获取通知列表失败")}catch(a){T.error("获取通知列表失败")}finally{s.value=!1}},handleFilterChange=()=>{Y.value=1,fetchNoticeList()},handleCurrentChange=e=>{Y.value=e,fetchNoticeList()},handlePageSizeChange=e=>{O.value=e,Y.value=1,fetchNoticeList()},handleNoticeClick=async a=>{try{const l=await(t=a.id,e({url:`/api/reservation/notice/${t}`,method:"get"}));if(0===l.data.code){const e=l.data.data;Object.assign(R,e),U.value=!0}else T.error(l.data.msg||"获取通知详情失败")}catch(l){T.error("获取通知详情失败")}var t};return o(()=>{a().subscribe("venue_notice",e=>{r({title:"通知公告",message:e.payload,type:"info"})}),fetchNoticeList()}),(e,a)=>{const t=g,i=y,n=V,o=z,r=N,T=C,I=_,E=w,q=x,A=f;return $(),u("div",X,[a[4]||(a[4]=c("h2",{class:"page-title"},"通知公告",-1)),c("div",ee,[m(i,{modelValue:l.value,"onUpdate:modelValue":a[0]||(a[0]=e=>l.value=e),placeholder:"选择通知类型",clearable:"",onChange:handleFilterChange},{default:p(()=>[m(t,{label:"全部通知",value:null}),m(t,{label:"普通通知",value:1}),m(t,{label:"重要通知",value:2})]),_:1},8,["modelValue"])]),d(($(),u("div",ae,[M.value.length>0?($(),b(T,{key:0,height:"300px",autoplay:!0,interval:5e3,"indicator-position":"outside",arrow:"hover",type:"card"},{default:p(()=>[($(!0),u(h,null,k(M.value,e=>($(),b(r,{key:e.id,onClick:a=>handleNoticeClick(e)},{default:p(()=>[c("div",{class:j(["notice-card",{important:2===e.type}])},[c("div",te,[c("h3",le,S(e.title),1),c("div",se,[m(n,{type:getTypeTag(e.type),size:"small"},{default:p(()=>[D(S(getTypeText(e.type)),1)]),_:2},1032,["type"]),c("span",ie,S(formatTime(e.publishTime)),1)])]),c("div",ne,S(truncateContent(e.content,200)),1),c("div",oe,[m(o,{type:"primary",size:"small",onClick:H(a=>handleNoticeClick(e),["stop"])},{default:p(()=>[...a[2]||(a[2]=[D(" 查看详情 ",-1)])]),_:1},8,["onClick"])])],2)]),_:2},1032,["onClick"]))),128))]),_:1})):v("",!0),s.value||0!==M.value.length?v("",!0):($(),u("div",re,[m(I,{description:"暂无通知"})]))])),[[A,s.value]]),M.value.length>0?($(),u("div",ue,[a[3]||(a[3]=c("h3",{class:"grid-title"},"所有通知",-1)),c("div",ce,[($(!0),u(h,null,k(M.value,e=>($(),u("div",{key:`grid-${e.id}`,class:j(["notice-grid-item",{important:2===e.type}]),onClick:a=>handleNoticeClick(e)},[c("div",ve,[c("span",me,S(e.title),1),m(n,{type:getTypeTag(e.type),size:"small"},{default:p(()=>[D(S(getTypeText(e.type)),1)]),_:2},1032,["type"])]),c("div",pe,S(formatTime(e.publishTime)),1)],10,de))),128))])])):v("",!0),P.value>0?($(),u("div",ge,[m(E,{background:"","hide-on-single-page":!1,layout:"total, sizes, prev, pager, next",total:P.value,"page-size":O.value,"page-sizes":[5,8,10],"current-page":Y.value,onCurrentChange:handleCurrentChange,onSizeChange:handlePageSizeChange},null,8,["total","page-size","current-page"])])):v("",!0),m(q,{modelValue:U.value,"onUpdate:modelValue":a[1]||(a[1]=e=>U.value=e),title:R.title,width:"60%"},{default:p(()=>[c("div",ye,[c("div",fe,[m(n,{type:getTypeTag(R.type)},{default:p(()=>[D(S(getTypeText(R.type)),1)]),_:1},8,["type"]),c("span",be,"发布时间："+S(formatTime(R.publishTime)),1)]),c("div",he,S(R.content),1)])]),_:1},8,["modelValue","title"])])}}},[["__scopeId","data-v-b58188c4"]]);const _e={class:"matrix-container"},we={class:"date-selector"},Ve={class:"date-info"},De={key:0,class:"workday-info"},Se={key:1,class:"weekend-info"},xe={class:"legend"},Te={class:"legend-text"},Ce={class:"matrix-table"},$e={class:"status-matrix"},Ne={class:"venue-name"},je=["onClick","title"],ze={class:"dialog-footer"},He=s({__name:"VenueStatusMatrix",props:{visible:{type:Boolean,default:!1}},emits:["close"],setup(a,{emit:t}){const l=a,s=Y({get:()=>l.visible});O(()=>l.visible,e=>{e&&fetchMatrixData()},{immediate:!0});const n=t,closeDialog=()=>{n("close")},o=i(!1),r=i({}),v=i(new Date),g=i([]),y=i([]),_={1:"#67c23a",2:"#909399",3:"#f56c6c",4:"#e6a23c"},w={1:"空闲中",2:"使用中",3:"已预约",4:"不开放"},fetchMatrixData=async()=>{if(l.visible){o.value=!0;try{const l=`${(t=v.value).getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`,s=await(a={date:l},e({url:"/api/venue/status-matrix",method:"get",params:a}));0===s.data.code&&(r.value=s.data.data.statusMatrix||{},y.value=s.data.data.venues||[],g.value=s.data.data.timeSlots||[])}catch(s){T.error("获取场地状态矩阵失败")}finally{o.value=!1}var a,t}},isWeekday=e=>{const a=e.getDay();return a>=1&&a<=5},disabledDate=e=>{const a=new Date;a.setHours(0,0,0,0);const t=new Date(a);t.setDate(t.getDate()+1);const l=new Date(e);return l.setHours(0,0,0,0),!(l.getTime()===a.getTime()||l.getTime()===t.getTime())},getCellStatus=(e,a)=>{const t=r.value[e];return t&&t[a]?t[a].status:1},getCellStyle=(e,a)=>{const t=getCellStatus(e,a);return{backgroundColor:_[t],color:"#fff",textAlign:"center",padding:"8px 4px",fontSize:"12px",cursor:"pointer",transition:"all 0.3s"}},handleDateChange=()=>{fetchMatrixData()};return(e,a)=>{const t=P,l=z,i=x,n=f;return $(),b(i,{modelValue:s.value,"onUpdate:modelValue":a[1]||(a[1]=e=>s.value=e),title:"场地使用情况表",width:"90%","close-on-click-modal":!1,onClose:closeDialog,class:"venue-matrix-dialog"},{footer:p(()=>[c("div",ze,[m(l,{onClick:closeDialog},{default:p(()=>[...a[4]||(a[4]=[D("关闭",-1)])]),_:1}),m(l,{type:"primary",onClick:fetchMatrixData},{default:p(()=>[...a[5]||(a[5]=[D("刷新数据",-1)])]),_:1})])]),default:p(()=>[c("div",_e,[c("div",we,[m(t,{modelValue:v.value,"onUpdate:modelValue":a[0]||(a[0]=e=>v.value=e),type:"date",placeholder:"选择查询日期",format:"YYYY年MM月DD日",onChange:handleDateChange,"disabled-date":disabledDate},null,8,["modelValue"]),c("div",Ve,[isWeekday(v.value)?($(),u("span",De," 工作日：白天场地用于校内上课，仅晚上18:00-21:00开放预约 ")):($(),u("span",Se," 周末：全天开放预约，时间为8:00-21:00 "))])]),c("div",xe,[($(),u(h,null,k(_,(e,a)=>c("div",{class:"legend-item",key:a},[c("div",{class:"legend-color",style:M({backgroundColor:e})},null,4),c("span",Te,S(w[a]),1)])),64))]),d(($(),u("div",Ce,[c("table",$e,[c("thead",null,[c("tr",null,[a[2]||(a[2]=c("th",{class:"venue-header"},"场地/时间",-1)),($(!0),u(h,null,k(g.value,e=>($(),u("th",{key:e,class:"time-header"},S(e),1))),128))])]),c("tbody",null,[($(!0),u(h,null,k(y.value,e=>($(),u("tr",{key:e.id},[c("td",Ne,S(e.name),1),($(!0),u(h,null,k(g.value,a=>($(),u("td",{key:a,class:"status-cell",style:M(getCellStyle(e.id,a)),onClick:t=>((e,a)=>{const t=r.value[e.id];if(!t||!t[a])return;const l=t[a],s=l.status;let i="";i=1!==s?`${e.name} ${a} - ${w[s]} - ${l.reason}`:`${e.name} ${a} - ${w[s]}`,1===s?T.success(i):2===s?T.warning(i):3===s?T.error(i):4===s&&T.warning(i)})(e,a),title:`${e.name} ${a} - ${w[getCellStatus(e.id,a)]}`},S(w[getCellStatus(e.id,a)]),13,je))),128))]))),128))])])])),[[n,o.value]]),a[3]||(a[3]=c("div",{class:"matrix-info"},[c("p",null,[c("strong",null,"使用说明：")]),c("ul",null,[c("li",null,"点击单元格可查看详细信息"),c("li",null,"绿色表示可预约，红色表示已预约，橙色表示维护中，灰色表示不开放"),c("li",null,"工作日白天时间段场地用于校内上课，不对外开放"),c("li",null,"周末全天开放预约")])],-1))])]),_:1},8,["modelValue"])}}},[["__scopeId","data-v-64f68edf"]]),Ye={class:"create-order-form"},Oe={class:"form-header"},Pe={class:"form-title"},Me={class:"form-section venue-section"},Ue={class:"section-header"},Re={key:0,class:"venue-card"},Ie={class:"venue-info"},Ee={class:"venue-name"},qe={class:"venue-description"},Ae={class:"venue-price"},Fe={class:"price-value"},Be={class:"form-section time-section"},Ge={class:"section-header"},Ke={class:"time-display-grid"},Le={class:"time-display-item"},Qe={class:"time-value"},Ze={class:"time-display-item"},Je={class:"time-value"},We={class:"time-display-item"},Xe={class:"time-value"},ea={key:0,class:"booking-summary"},aa={class:"summary-item"},ta={class:"summary-value"},la={class:"summary-item total-price"},sa={class:"summary-value price"},ia={class:"price-note"},na={class:"form-section contact-section"},oa={class:"section-header"},ra={class:"contact-form-grid"},ua={class:"form-section notice-section"},ca={class:"section-header"},da={class:"notice-content"},va={class:"form-actions"},ma=s({__name:"CreateOrderForm",props:{selectedVenue:{type:Object,default:()=>({})},reservationDate:{type:String,default:""},startTime:{type:String,default:""},endTime:{type:String,default:""}},emits:["cancel"],setup(e,{emit:a}){const s=t(),n=e,o=a,r=i(null),d=i(!1),g=i({venueId:"",contactName:"",contactPhone:"",remark:""}),y={venueId:[{required:!0,message:"请选择场地",trigger:"change"}],contactName:[{required:!0,message:"请输入联系人姓名",trigger:"blur"},{min:2,max:20,message:"姓名长度在2-20个字符",trigger:"blur"},{pattern:/^[\u4e00-\u9fa5a-zA-Z\s]+$/,message:"姓名只能包含中文、英文和空格",trigger:"blur"}],contactPhone:[{required:!0,message:"请输入手机号码",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}],remark:[{max:200,message:"备注不能超过200个字符",trigger:"blur"}]},f=Y(()=>{if(!n.startTime||!n.endTime)return 0;const[e]=n.startTime.split(":").map(Number),[a]=n.endTime.split(":").map(Number);return a-e}),b=Y(()=>{var e;const a=(null==(e=n.selectedVenue)?void 0:e.price)||30;return Math.ceil(f.value)*a});O(()=>n.selectedVenue,e=>{(null==e?void 0:e.id)&&(g.value.venueId=e.id)},{immediate:!0});const handleSubmit=async()=>{if(!r.value)return!1;try{await r.value.validate();const a={venueId:n.selectedVenue.id,reservationDate:n.reservationDate,startTime:n.startTime,endTime:n.endTime,remark:g.value.contactName+" "+g.value.contactPhone+" "+g.value.remark};d.value=!0;try{T.info("正在创建订单...");const e=await l(a);if(0!==e.data.code)return T.error(e.data.message||"创建订单失败"),!1;s.push({path:"/payment",query:{orderNo:e.data.data.orderNo},state:{orderDetail:{id:e.data.data.id,venueName:n.selectedVenue.name,venueId:n.selectedVenue.id,reservationDate:a.reservationDate,startTime:a.startTime,endTime:a.endTime,duration:f.value,contactName:g.value.contactName,contactPhone:g.value.contactPhone,remark:e.data.data.remark,payTypeDesc:e.data.data.payTypeDesc,pricePerHour:e.data.data.pricePerHour||30,totalAmount:e.data.data.totalAmount}}})}catch(e){return T.error("创建订单失败，请重试"),!1}finally{d.value=!1}}catch(e){return!1}},handleCancel=()=>{o("cancel")};return(e,a)=>{const t=I,l=B,s=F,i=G,o=z,h=K;return $(),u("div",Ye,[c("div",Oe,[c("h3",Pe,[m(t,null,{default:p(()=>[m(U(R))]),_:1}),a[3]||(a[3]=D(" 创建预约订单 ",-1))]),a[4]||(a[4]=c("p",{class:"form-subtitle"},"请填写完整的预约信息，确保信息准确无误",-1))]),m(h,{ref_key:"formRef",ref:r,model:g.value,rules:y,"label-width":"100px",class:"order-form",size:"large"},{default:p(()=>{var e,r;return[c("div",Me,[c("div",Ue,[m(t,{class:"section-icon"},{default:p(()=>[m(U(E))]),_:1}),a[5]||(a[5]=c("h4",{class:"section-title"},"场地信息",-1))]),(null==(e=n.selectedVenue)?void 0:e.id)?($(),u("div",Re,[c("div",Ie,[c("h5",Ee,S(n.selectedVenue.name),1),c("p",qe,S(n.selectedVenue.description||"标准羽毛球场地，配备专业羽毛球网和照明设备"),1),c("div",Ae,[a[6]||(a[6]=c("span",{class:"price-label"},"价格：",-1)),c("span",Fe,S(n.selectedVenue.price||30)+"元/小时",1)])])])):v("",!0)]),c("div",Be,[c("div",Ge,[m(t,{class:"section-icon"},{default:p(()=>[m(U(q))]),_:1}),a[7]||(a[7]=c("h4",{class:"section-title"},"预约时间",-1))]),c("div",Ke,[c("div",Le,[a[8]||(a[8]=c("span",{class:"time-label"},"预约日期",-1)),c("div",Qe,S(n.reservationDate||"未选择"),1)]),c("div",Ze,[a[9]||(a[9]=c("span",{class:"time-label"},"开始时间",-1)),c("div",Je,S(n.startTime||"未选择"),1)]),c("div",We,[a[10]||(a[10]=c("span",{class:"time-label"},"结束时间",-1)),c("div",Xe,S(n.endTime||"未选择"),1)])]),f.value>0?($(),u("div",ea,[c("div",aa,[m(t,null,{default:p(()=>[m(U(A))]),_:1}),a[11]||(a[11]=c("span",{class:"summary-label"},"预约时长：",-1)),c("span",ta,S(f.value)+"小时",1)]),c("div",la,[m(t,null,{default:p(()=>[m(U(R))]),_:1}),a[12]||(a[12]=c("span",{class:"summary-label"},"预计费用：",-1)),c("span",sa,"¥"+S(b.value),1)]),c("div",ia," （按"+S((null==(r=n.selectedVenue)?void 0:r.price)||30)+"元/小时计算，不足1小时按1小时计费） ",1)])):v("",!0)]),c("div",na,[c("div",oa,[m(t,{class:"section-icon"},{default:p(()=>[m(U(R))]),_:1}),a[13]||(a[13]=c("h4",{class:"section-title"},"联系人信息",-1))]),c("div",ra,[m(s,{label:"联系人姓名",prop:"contactName"},{default:p(()=>[m(l,{modelValue:g.value.contactName,"onUpdate:modelValue":a[0]||(a[0]=e=>g.value.contactName=e),placeholder:"请输入联系人姓名",disabled:d.value,clearable:"",size:"large"},{prefix:p(()=>[m(t,null,{default:p(()=>[m(U(R))]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),m(s,{label:"联系电话",prop:"contactPhone"},{default:p(()=>[m(l,{modelValue:g.value.contactPhone,"onUpdate:modelValue":a[1]||(a[1]=e=>g.value.contactPhone=e),placeholder:"请输入手机号码",disabled:d.value,clearable:"",size:"large",maxlength:"11"},{prefix:p(()=>[m(t,null,{default:p(()=>[m(U(R))]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1})]),m(s,{label:"备注信息",prop:"remark"},{default:p(()=>[m(l,{modelValue:g.value.remark,"onUpdate:modelValue":a[2]||(a[2]=e=>g.value.remark=e),type:"textarea",placeholder:"请输入备注信息（选填）",disabled:d.value,rows:3,maxlength:"200","show-word-limit":"",resize:"none"},null,8,["modelValue","disabled"])]),_:1})]),c("div",ua,[c("div",ca,[m(t,{class:"section-icon"},{default:p(()=>[m(U(R))]),_:1}),a[14]||(a[14]=c("h4",{class:"section-title"},"预约须知",-1))]),c("div",da,[m(i,{title:"重要提醒",type:"warning",closable:!1,"show-icon":""},{default:p(()=>[...a[15]||(a[15]=[c("ul",{class:"notice-list"},[c("li",null,"请确保预约信息准确无误，提交后不可修改"),c("li",null,"如需取消预约，请至少提前半小时联系管理员"),c("li",null,"请爱护场地设施，如有损坏需要赔偿"),c("li",null,"场地内禁止吸烟，请保持环境整洁")],-1)])]),_:1})])]),c("div",va,[m(o,{size:"large",disabled:d.value,onClick:handleCancel},{default:p(()=>[...a[16]||(a[16]=[D(" 取消 ",-1)])]),_:1},8,["disabled"]),m(o,{type:"primary",size:"large",loading:d.value,onClick:handleSubmit},{default:p(()=>[D(S(d.value?"创建中...":"确认预约"),1)]),_:1},8,["loading"])])]}),_:1},8,["model"])])}}},[["__scopeId","data-v-3d5b6ff2"]]),pa={class:"booking-container"},ga={class:"booking-tools"},ya={class:"date-time-selector"},fa={class:"selector-group"},ba={class:"matrix-button-container"},ha={class:"date-status"},ka={class:"status-text"},_a={key:0,class:"selector-group time-selector"},wa={class:"time-picker-container"},Va={class:"time-picker"},Da={class:"time-picker"},Sa={class:"courts-container"},xa={key:0,class:"loading-container"},Ta={class:"court-info"},Ca={class:"court-name"},$a={class:"court-status"},Na={class:"court-description"},ja={class:"court-price"},za=s({__name:"BookingView",setup(a){const isWeekday=e=>{const a=e.getDay();return a>=1&&a<=5},isWeekend=e=>{const a=e.getDay();return 0===a||6===a},isBookingTimeValid=(e,a)=>{const t=new Date,l=new Date;l.setHours(0,0,0,0);const s=new Date(l);s.setDate(s.getDate()+1);const i=new Date(e);if(i.setHours(0,0,0,0),i.getTime()===l.getTime()){const[e,l]=a.split(":").map(Number),s=new Date;return s.setHours(e,l,0,0),t.getTime()<s.getTime()}if(i.getTime()===s.getTime()){return t.getHours()>=18}return!1},getTimeRestrictionText=e=>{const a=new Date,t=new Date;t.setHours(0,0,0,0);const l=new Date(t);l.setDate(l.getDate()+1);const s=new Date(e);return s.setHours(0,0,0,0),s.getTime()===l.getTime()&&a.getHours()<18?"不在可预约时间（明天场地需今天18:00后预约）":null},getTimeOptionsForDate=e=>{const a=(e=>isWeekday(e)?["18:00-21:00"]:isWeekend(e)?["8:00-21:00"]:[])(e);if(0===a.length)return{startOptions:[],endOptions:[]};const t=[],l=[],s=a[0],[i,n]=s.split("-"),[o,r]=i.split(":").map(Number),[u,c]=n.split(":").map(Number);let d=o,v=r,m=u-1,p=c;for(p<v&&(m-=1,p+=60);d<m||d===m&&v<=p;){const a=`${d.toString().padStart(2,"0")}:${v.toString().padStart(2,"0")}`;isBookingTimeValid(e,a)&&t.push(a),d+=1}let g=o+1,y=r;for(;g<u||g===u&&y<=c;){const e=`${g.toString().padStart(2,"0")}:${y.toString().padStart(2,"0")}`;l.push(e),g+=1}return{startOptions:[...new Set(t)].sort(),endOptions:[...new Set(l)].sort()}},t=Y(()=>getTimeOptionsForDate(s.value).startOptions||[]),l=Y(()=>{const e=getTimeOptionsForDate(s.value);if(!n.value||0===e.endOptions.length)return[];const[a,t]=n.value.split(":").map(Number),l=`${(a+3).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`;return e.endOptions.filter(e=>e<=l&&e>n.value)}),s=i(new Date),n=i("18:00"),r=i("19:00");isWeekday(s.value)?(n.value="18:00",r.value="21:00"):(n.value="8:00",r.value="21:00");const handleDateChange=async e=>{t.value.length>0?(n.value=t.value[0],l.value.length>0&&(r.value=l.value[0])):(n.value="",r.value=""),n.value&&r.value&&n.value<r.value&&await checkVenueAvailability(e,n.value,r.value)},getDateStatusText=e=>{let a="";isWeekday(e)?a="工作日（仅晚上18:00-21:00开放）":isWeekend(e)&&(a="周末（全天开放8:00-21:00）");const t=getTimeRestrictionText(e);return t&&(a+=` - ${t}`),a},d=i([]),f=i(!1),fetchVenueList=async()=>{f.value=!0;try{const a=await e({url:"/api/venue/list",method:"get"});0===a.data.code?d.value=a.data.data.map(e=>({id:e.id,name:e.name,description:e.description,price:e.pricePerHour||20,status:e.status,bookable:!1,availabilityReason:"请选择时间段",location:e.location})):T.error(a.message||"获取场地列表失败")}catch(a){T.error("获取场地列表失败，请稍后重试")}finally{f.value=!1}},checkVenueAvailability=async(a,t,l)=>{try{const i=getTimeRestrictionText(a);if(i||!isBookingTimeValid(a,t))return void d.value.forEach(e=>{e.bookable=!1,e.availabilityReason=i||"不在可预约时间"});const n=(e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`)(a),o=await(s={date:n,startTime:t,endTime:l},e({url:"/api/venue/availability",method:"get",params:s}));if(0===o.data.code){const{availableVenues:e,unavailableVenues:a}=o.data.data;d.value.forEach(e=>{e.bookable=!1,e.availabilityReason="未知状态"}),e&&e.length>0&&e.forEach(e=>{const a=d.value.find(a=>a.id===e.id);a&&(a.bookable=!0,a.availabilityReason="可预约",void 0!==e.pricePerHour&&(a.price=e.pricePerHour))}),a&&a.length>0&&a.forEach(e=>{const a=d.value.find(a=>a.id===e.id);a&&(a.bookable=!1,a.availabilityReason=e.reason||"不可预约")})}}catch(i){d.value.forEach(e=>{e.bookable=!1,e.availabilityReason="检查失败"})}var s};o(async()=>{await fetchVenueList(),await handleDateChange(s.value),await handleStartTimeChange(n.value)});const _=i(!1),w=i(null),V=i(null),closeBookingDialog=()=>{_.value=!1,w.value=null},cancelBooking=()=>{closeBookingDialog()},C=i(!1),closeMatrixDialog=()=>{C.value=!1},openMatrixDialog=()=>{C.value=!0},isCourtBookable=e=>!!e.bookable&&(!(!n.value||!r.value)&&isBookingTimeValid(s.value,n.value)),getStatusClass=e=>e.bookable?"status-available":e.availabilityReason&&"请选择时间段"!==e.availabilityReason?"status-booked":"status-closed",getStatusText=e=>e.bookable?"可预约":e.availabilityReason||"状态未知",handleBookingSuccess=async()=>{closeBookingDialog(),T.success("预约成功！"),n.value&&r.value&&await checkVenueAvailability(s.value,n.value,r.value)},handleStartTimeChange=async e=>{if(0===t.value.length)return;e>=r.value&&(r.value=l.value[0]);r.value.split(":").map(Number)[0]-e.split(":").map(Number)[0]>3&&(r.value=l.value[l.value.length-1]),r.value&&await checkVenueAvailability(s.value,e,r.value)},handleEndTimeChange=async e=>{if(e<=n.value)if(isWeekday(s.value)){const a=l.value.indexOf(e);n.value=t.value[a]}else n.value="18:00";n.value&&await checkVenueAvailability(s.value,n.value,e)};return(e,a)=>{var i;const o=P,T=z,N=g,H=y,Y=L,O=J,M=Z,R=Q,I=x;return $(),u("div",pa,[a[12]||(a[12]=c("div",{class:"page-header"},[c("h2",null,"场地预约")],-1)),m(ke),c("div",ga,[c("div",ya,[c("div",fa,[a[5]||(a[5]=c("p",null,"选择日期：",-1)),m(o,{modelValue:s.value,"onUpdate:modelValue":a[0]||(a[0]=e=>s.value=e),type:"date",placeholder:"选择预约日期","disabled-date":e=>{const a=new Date;a.setHours(0,0,0,0);const t=new Date(a);return t.setDate(t.getDate()+1),!(e.toDateString()===a.toDateString()||e.toDateString()===t.toDateString())},format:"YYYY年MM月DD日",onChange:handleDateChange},null,8,["modelValue","disabled-date"])]),c("div",ba,[m(T,{type:"primary",icon:U(q),onClick:openMatrixDialog,class:"matrix-button-enhanced",size:"large"},{default:p(()=>[...a[6]||(a[6]=[c("span",{class:"button-text"},"查看场地使用情况表",-1),c("span",{class:"button-subtitle"},"实时查看所有场地状态",-1)])]),_:1},8,["icon"])]),c("div",ha,[c("span",ka,S(getDateStatusText(s.value)),1)]),t.value.length>0?($(),u("div",_a,[a[8]||(a[8]=c("p",null,"时间段：",-1)),c("div",wa,[c("div",Va,[m(H,{modelValue:n.value,"onUpdate:modelValue":a[1]||(a[1]=e=>n.value=e),placeholder:"开始时间",onChange:handleStartTimeChange,class:"time-select"},{default:p(()=>[($(!0),u(h,null,k(t.value,e=>($(),b(N,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),a[7]||(a[7]=c("span",{class:"time-separator"},"至",-1)),c("div",Da,[m(H,{modelValue:r.value,"onUpdate:modelValue":a[2]||(a[2]=e=>r.value=e),placeholder:"结束时间",onChange:handleEndTimeChange,class:"time-select"},{default:p(()=>[($(!0),u(h,null,k(l.value,e=>($(),b(N,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])])):v("",!0)]),a[9]||(a[9]=c("div",{class:"booking-rules"},[c("p",null,[c("strong",null,"预约规则：")]),c("ul",null,[c("li",null,"工作日（周一至周五）：白天场地用于校内上课，仅晚上18:00-21:00开放预约"),c("li",null,"周末（周六、周日）：全天开放预约，时间为8:00-21:00"),c("li",null,"预约时长为1-3小时，每小时20元，时间选择步长为1小时"),c("li",null,"一人一天只能预约一次，如果当天已预约则无法再次预约"),c("li",null,"只能预约今天和明天的场地"),c("li",null,"今天场地：只要在开始时间之前都可以预约（如果有剩余）"),c("li",null,"明天场地：今天18:00之后才能开始预约")])],-1))]),c("div",Sa,[a[11]||(a[11]=c("h3",null,"场地状态",-1)),f.value?($(),u("div",xa,[m(Y,{rows:3,animated:""}),a[10]||(a[10]=c("p",{class:"loading-text"},"正在加载场地信息...",-1))])):($(),b(R,{key:1,gutter:20},{default:p(()=>[($(!0),u(h,null,k(d.value,e=>($(),b(M,{xs:24,sm:12,md:8,key:e.id},{default:p(()=>[m(O,{class:j(["court-card",getStatusClass(e)])},{default:p(()=>[c("div",Ta,[c("div",Ca,S(e.name),1),c("div",$a,S(getStatusText(e)),1),c("div",Na,S(e.description),1),c("div",ja,"¥"+S(e.price)+"/小时",1),m(T,{type:"primary",disabled:!isCourtBookable(e),onClick:a=>(e=>{w.value=e,_.value=!0})(e),class:"book-button"},{default:p(()=>[D(S(isCourtBookable(e)?"立即预约":"暂不可预约"),1)]),_:2},1032,["disabled","onClick"])])]),_:2},1032,["class"])]),_:2},1024))),128))]),_:1}))]),m(I,{modelValue:_.value,"onUpdate:modelValue":a[3]||(a[3]=e=>_.value=e),title:`预约 ${null==(i=w.value)?void 0:i.name}`,width:"600px",onClose:closeBookingDialog},{default:p(()=>[w.value?($(),b(ma,{key:0,ref_key:"createOrderFormRef",ref:V,court:w.value,date:s.value,"start-time":n.value,"end-time":r.value,onSuccess:handleBookingSuccess,onCancel:cancelBooking},null,8,["court","date","start-time","end-time"])):v("",!0)]),_:1},8,["modelValue","title"]),m(I,{modelValue:C.value,"onUpdate:modelValue":a[4]||(a[4]=e=>C.value=e),title:"场地使用情况表",width:"90%",onClose:closeMatrixDialog},{default:p(()=>[C.value?($(),b(He,{key:0,"current-date":s.value,"start-time":n.value,"end-time":r.value},null,8,["current-date","start-time","end-time"])):v("",!0)]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-7de6964d"]]);export{za as default};
