function E(e={}){const{enableFPS:t=!0,fpsInterval:r=1e3,enableInteractivity:u=!0,enableNetworkQuality:n=!0,enableDeviceInfo:c=!0,onMetric:s}=e,a=[];if(t)try{const o=v(s,r);a.push(o)}catch(o){console.warn("FPS监控启动失败:",o)}if(u)try{const o=p(s);a.push(o)}catch(o){console.warn("交互性监控启动失败:",o)}if(n)try{const o=f(s);a.push(o)}catch(o){console.warn("网络质量监控启动失败:",o)}if(c)try{h(s)}catch(o){console.warn("设备信息收集失败:",o)}try{const o=w(s);a.push(o)}catch(o){console.warn("页面可见性监控启动失败:",o)}try{const o=g(s);a.push(o)}catch(o){console.warn("页面生命周期监控启动失败:",o)}return()=>{a.forEach(o=>{try{o()}catch(i){console.warn("清理高级指标监控资源失败:",i)}}),a.length=0}}function v(e,t=1e3){let r=0,u=performance.now(),n,c;const s=()=>{r++,n=requestAnimationFrame(s)},a=()=>{const o=performance.now(),i=o-u,m=Math.round(r*1e3/i);e==null||e({type:"custom",name:"fps",value:m,unit:"fps",rating:m>=55?"good":m>=30?"needs-improvement":"poor",ts:Date.now(),source:"advanced-metrics",attrs:{frameCount:r,deltaTime:Math.round(i),sampleInterval:t}}),r=0,u=o};return n=requestAnimationFrame(s),c=window.setInterval(a,t),()=>{cancelAnimationFrame(n),clearInterval(c)}}function p(e){const t=["click","keydown","scroll","touchstart"],r=[];t.forEach(a=>{const o=i=>{const m=performance.now();setTimeout(()=>{var l;const d=performance.now()-m;e==null||e({type:"event",name:`${a}-response`,value:Math.round(d),unit:"ms",rating:d<=16?"good":d<=50?"needs-improvement":"poor",ts:Date.now(),source:"advanced-metrics",attrs:{eventType:a,target:(l=i.target)==null?void 0:l.tagName,timestamp:m,clientX:i.clientX,clientY:i.clientY,key:i.key}})},0)};document.addEventListener(a,o,{passive:!0}),r.push({event:a,handler:o})});let u=0;const n=performance.now(),s=setInterval(()=>{e==null||e({type:"custom",name:"total-blocking-time",value:Math.round(u),unit:"ms",rating:"good",ts:Date.now(),source:"advanced-metrics",attrs:{monitoringDuration:performance.now()-n,sampleCount:Math.floor((performance.now()-n)/5e3)}})},5e3);return()=>{r.forEach(({event:a,handler:o})=>{document.removeEventListener(a,o)}),clearInterval(s)}}function f(e){const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(!t)return console.warn("当前浏览器不支持Network Information API"),()=>{};const r=()=>{try{e==null||e({type:"custom",name:"network-quality",value:t.downlink||0,unit:"mbps",rating:D(t.effectiveType),ts:Date.now(),source:"advanced-metrics",attrs:{effectiveType:t.effectiveType,downlink:t.downlink,rtt:t.rtt,saveData:t.saveData,downlinkMax:t.downlinkMax,type:t.type}})}catch(n){console.warn("网络信息获取失败:",n)}};r();const u=r;return t.addEventListener("change",u),()=>{try{t.removeEventListener("change",u)}catch(n){console.warn("移除网络事件监听器失败:",n)}}}function h(e){var u;try{const n=navigator.hardwareConcurrency||0;e==null||e({type:"custom",name:"device-cpu-cores",value:n,unit:"cores",rating:n>=8?"good":n>=4?"needs-improvement":"poor",ts:Date.now(),source:"advanced-metrics",attrs:{supported:navigator.hardwareConcurrency!==void 0,userAgent:navigator.userAgent.substring(0,100)}})}catch(n){console.warn("CPU信息收集失败:",n)}try{const n=navigator.deviceMemory;n!==void 0?e==null||e({type:"custom",name:"device-memory",value:n,unit:"gb",rating:n>=8?"good":n>=4?"needs-improvement":"poor",ts:Date.now(),source:"advanced-metrics",attrs:{memoryGB:n,isApproximateValue:!0,privacyNote:"该值经过量化处理以保护隐私"}}):e==null||e({type:"custom",name:"device-memory",value:-1,unit:"gb",rating:void 0,ts:Date.now(),source:"advanced-metrics",attrs:{supported:!1,reason:"浏览器不支持Device Memory API"}})}catch(n){console.warn("设备内存信息收集失败:",n)}try{const n=screen.width*screen.height;e==null||e({type:"custom",name:"screen-info",value:n,unit:"pixels",ts:Date.now(),source:"advanced-metrics",attrs:{width:screen.width,height:screen.height,colorDepth:screen.colorDepth,pixelRatio:window.devicePixelRatio,availWidth:screen.availWidth,availHeight:screen.availHeight,orientation:(u=screen.orientation)==null?void 0:u.type,screenType:n>2073600?"desktop":n>921600?"tablet":"mobile"}})}catch(n){console.warn("屏幕信息收集失败:",n)}const t=navigator.userAgent,r=y(t);e==null||e({type:"custom",name:"browser-info",value:0,unit:"count",ts:Date.now(),source:"custom",attrs:{browser:r.name,version:r.version,mobile:/Mobile|Android|iPhone|iPad/.test(t),platform:navigator.platform}})}function w(e){let t=performance.now(),r=document.hidden;const u=()=>{const n=performance.now(),c=n-t;r&&!document.hidden?e==null||e({type:"custom",name:"page-hidden-duration",value:Math.round(c),unit:"ms",ts:Date.now(),source:"custom",attrs:{visibilityState:document.visibilityState}}):!r&&document.hidden&&(e==null||e({type:"custom",name:"page-visible-duration",value:Math.round(c),unit:"ms",ts:Date.now(),source:"custom",attrs:{visibilityState:document.visibilityState}})),r=document.hidden,t=n};return document.addEventListener("visibilitychange",u),()=>{document.removeEventListener("visibilitychange",u)}}function g(e){const t=performance.now(),r=()=>{const s=performance.now()-t;e==null||e({type:"custom",name:"session-duration",value:Math.round(s),unit:"ms",ts:Date.now(),source:"custom"})};let u=null;const n=()=>{u=performance.now()},c=()=>{if(u){const s=performance.now()-u;e==null||e({type:"custom",name:"page-freeze-duration",value:Math.round(s),unit:"ms",ts:Date.now(),source:"custom"}),u=null}};return window.addEventListener("beforeunload",r),document.addEventListener("freeze",n),document.addEventListener("resume",c),()=>{window.removeEventListener("beforeunload",r),document.removeEventListener("freeze",n),document.removeEventListener("resume",c)}}function D(e){switch(e){case"4g":return"good";case"3g":return"needs-improvement";case"2g":case"slow-2g":default:return"poor"}}function y(e){if(e.includes("Chrome")){const t=e.match(/Chrome\/(\d+)/);return{name:"Chrome",version:(t==null?void 0:t[1])||"unknown"}}else if(e.includes("Firefox")){const t=e.match(/Firefox\/(\d+)/);return{name:"Firefox",version:(t==null?void 0:t[1])||"unknown"}}else if(e.includes("Safari")){const t=e.match(/Version\/(\d+).*Safari/);return{name:"Safari",version:(t==null?void 0:t[1])||"unknown"}}else if(e.includes("Edge")){const t=e.match(/Edge\/(\d+)/);return{name:"Edge",version:(t==null?void 0:t[1])||"unknown"}}return{name:"Unknown",version:"unknown"}}function C(e){const t=[];if("PerformanceObserver"in window)try{const r=new PerformanceObserver(u=>{u.getEntries().forEach(n=>{n.renderBlockingStatus&&(e==null||e({type:"custom",name:"render-blocking-resource",value:Math.round(n.duration),unit:"ms",rating:n.duration<=100?"good":n.duration<=300?"needs-improvement":"poor",ts:Date.now(),source:"performance-observer",attrs:{url:n.name,renderBlockingStatus:n.renderBlockingStatus,initiatorType:n.initiatorType}}))})});r.observe({entryTypes:["resource"],buffered:!0}),t.push(r)}catch(r){console.warn("Failed to observe render-blocking resources:",r)}return()=>{t.forEach(r=>r.disconnect())}}function b(e,t=6e4){if(typeof performance.memory>"u")return console.warn("当前浏览器不支持performance.memory API，无法进行内存泄漏检测"),()=>{};const r=[],u=10,n=Date.now(),c=()=>{try{const a=performance.memory,o=a.usedJSHeapSize;if(r.push(o),r.length>u&&r.shift(),r.length>=5){const i=F(r),m=i>.1;e==null||e({type:"custom",name:"memory-leak-detection",value:Math.round(i*100)/100,unit:"trend",rating:m?"poor":"good",ts:Date.now(),source:"advanced-metrics",attrs:{currentUsage:o,trend:Math.round(i*1e4)/1e4,leakDetected:m,readings:[...r],readingsCount:r.length,monitoringDuration:Date.now()-n,totalHeapSize:a.totalJSHeapSize,heapSizeLimit:a.jsHeapSizeLimit,usagePercent:Math.round(o/a.jsHeapSizeLimit*100)}})}}catch(a){console.warn("内存泄漏检测失败:",a)}};c();const s=setInterval(c,t);return()=>{clearInterval(s)}}function F(e){if(e.length<2)return 0;const t=e.length,r=e.reduce((o,i,m)=>o+m,0),u=e.reduce((o,i)=>o+i,0),n=e.reduce((o,i,m)=>o+m*i,0),c=e.reduce((o,i,m)=>o+m*m,0),s=(t*n-r*u)/(t*c-r*r),a=u/t;return a>0?s/a:0}export{C as monitorCriticalRenderingPath,E as startAdvancedMetrics,b as startMemoryLeakDetection};
