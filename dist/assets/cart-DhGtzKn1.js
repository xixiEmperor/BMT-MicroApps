import{Y as t,az as e,r as a,d as r,E as c}from"./index-BtPdgGUc.js";function removeCartItem(e,a){return t({url:`/api/cart/${e}`,method:"delete",data:a})}const i=e("cart",()=>{const e=a([]),i=a(!1),n=a(!1),u=r(()=>e.value.reduce((t,e)=>t+e.quantity,0)),o=r(()=>e.value.filter(t=>t.selected).reduce((t,e)=>t+(e.productPrice+(e.priceAdjustment||0))*e.quantity,0)),d=r(()=>e.value.filter(t=>t.selected).length);async function fetchCartList(){if(!n.value){n.value=!0;try{const a=await t({url:"/api/cart",method:"get"});if(0===a.data.code)return e.value=a.data.data.cartItems||[],i.value=a.data.data.allSelected||!1,!0;throw new Error(a.data.message||"获取购物车失败")}catch(a){return c.error("获取购物车失败"),!1}finally{n.value=!1}}}async function updateItemQuantity(e,a){if(a<=0)return await removeFromCart(e);if(a>e.stock)return c.warning(`商品"${e.productName}"已达到最大库存数量(${e.stock})`),!1;try{e.quantity=a,e.totalPrice=e.productPrice*a;const r={quantity:a};return e.specificationId&&(r.specs=e.specs),await function(e,a){return t({url:`/api/cart/${e}`,method:"put",data:a})}(e.productId,r),!0}catch(r){return c.error("更新数量失败"),!1}}async function removeFromCart(t){const a=e.value.findIndex(e=>t.specificationId?e.productId===t.productId&&e.specificationId===t.specificationId:e.productId===t.productId&&!e.specificationId);if(-1===a)return!1;try{e.value.splice(a,1);const r={};return t.specificationId&&(r.specs=t.specs),await removeCartItem(t.productId,r),c.success("商品已从购物车中移除"),!0}catch(r){return c.error("删除商品失败"),!1}}function updateAllSelectedState(){0===e.value.length?i.value=!1:i.value=e.value.every(t=>t.selected)}return{cartItems:e,isAllSelected:i,loading:n,totalCount:u,totalPrice:o,selectedCount:d,fetchCartList:fetchCartList,addToCart:async function(a){const r=void 0!==a.specificationId,i=e.value.findIndex(t=>r?t.productId===a.productId&&t.specificationId===a.specificationId:t.productId===a.productId&&!t.specificationId);try{if(i>=0){const t=e.value[i];if(t.quantity+a.quantity>t.stock)return c.warning("已达到最大库存数量"),!1;t.quantity+=a.quantity,t.totalPrice=t.productPrice*t.quantity}else e.value.push({...a,quantity:a.quantity,selected:!0,totalPrice:a.productPrice*a.quantity});const r={productId:a.productId,quantity:a.quantity};return a.specificationId&&(r.specs=a.specs),await function(e){return t({url:"/api/cart",method:"post",data:e})}(r),!0}catch(n){return c.error("添加到购物车失败"),!1}},updateItemQuantity:updateItemQuantity,increaseQuantity:async function(t){return await updateItemQuantity(t,t.quantity+1)},decreaseQuantity:async function(t){return await updateItemQuantity(t,t.quantity-1)},removeFromCart:removeFromCart,toggleSelectItem:async function(e){try{updateAllSelectedState();const a={selected:e.selected};return e.specificationId&&(a.specs=e.specs),await function(e,a){return t({url:`/api/cart/select/${e}`,method:"put",data:a})}(e.productId,a),!0}catch(a){return c.error("更新选择状态失败"),!1}},toggleSelectAll:async function(){try{return e.value.forEach(t=>{t.selected=i.value}),await(a=i.value,t({url:"/api/cart/select-all",method:"put",data:{selected:a}})),!0}catch(r){return c.error("更新全选状态失败"),!1}var a},clearCart:async function(){try{return e.value=[],i.value=!1,await t({url:"/api/cart",method:"delete"}),c.success("购物车已清空"),!0}catch(a){return c.error("清空购物车失败"),!1}},getSelectedItems:function(){return e.value.filter(t=>t.selected)},removeOrderedItems:async function(t){try{let r=[];if(t.product?r=[t.product]:t.products&&(r=t.products),0===r.length)return!0;let c=0,i=0;for(const t of r)try{const a=e.value.findIndex(e=>t.specificationId?e.productId===t.productId&&e.specificationId===t.specificationId:e.productId===t.productId&&!e.specificationId);if(-1!==a){e.value.splice(a,1);const r={};t.specificationId&&(r.specs=t.specs),await removeCartItem(t.productId,r),c++}else c++}catch(a){i++}return updateAllSelectedState(),0===i||(await fetchCartList(),!1)}catch(a){return await fetchCartList(),!1}},resetLoadingState:function(){n.value=!1}}},{persist:{paths:["cartItems","isAllSelected"],afterRestore:t=>{t.store.loading=!1}}});export{i as u};
