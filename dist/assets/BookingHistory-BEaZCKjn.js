import{a}from"./index-BuScbc3L.js";/* empty css                   */import{g as e,O as t,a as l,b as s,d as o,e as r}from"./venueOrder-qXvr7p9X.js";/* empty css                   *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                        */import"./el-tooltip-l0sNRNKZ.js";import{_ as u}from"./_plugin-vue_export-helper-CTKw_zaB.js";/* empty css                 *//* empty css                     *//* empty css                       */import{r as i,w as n,q as d,N as c,K as v,B as m,a3 as p,A as f,at as y,af as b,ae as w,aw as g,ag as _,y as k,M as h,aH as j,aj as C,Y as N,V as T,O as x,ai as z,aX as D,aY as A,ak as H,E as V,J as B,aG as P,z as $,ah as I}from"./element-plus-D8DMz00a.js";const O={class:"booking-history"},S={class:"container"},q={class:"filter-section"},E={class:"table-container"},M={key:2,class:"pagination"},U={key:0,class:"booking-detail"},Y={class:"dialog-footer"},G=u({__name:"BookingHistory",setup(u){const G=a(),J=i(!1),K=i({status:""});n(()=>K.value.status,a=>{fetchMyOrders(a)});const L=i(1),X=i(10),F=i(0),Q=i([]),R=i(!1),W=i(null),fetchMyOrders=async a=>{try{J.value=!0;const t=await e(a);0===t.data.code?(Q.value=t.data.data.list||[],F.value=t.data.data.total):V.error(t.message||"获取订单列表失败")}catch(t){V.error("获取订单列表失败，请稍后重试")}finally{J.value=!1}},handlePageChange=a=>{L.value=a},isBookingExpired=a=>{if(!a)return!0;const e=new Date;e.setHours(0,0,0,0);const t=new Date(a.date);return t.setHours(0,0,0,0),t<e},canCancel=a=>!!a&&("reserved"===a.status||1===a.status),getCancelButtonText=a=>a&&("cancelled"===a.status||4===a.status)?"已取消":"取消预订",getStatusText=a=>l[a]||a,getStatusTagType=a=>t[a]||"",cancelBooking=async a=>{try{await B.confirm(`确定要取消 ${a.reservationDate} ${a.timeSlot} ${a.venueName} 的预订吗？取消后无法恢复。`,"取消预订",{confirmButtonText:"确定",cancelButtonText:"返回",type:"warning"}),J.value=!0;const e=await o(a.id,{reason:"用户主动取消"});0===e.data.code?(V.success(e.data.data),await fetchMyOrders()):V.error(e.message||"取消预订失败")}catch(e){"cancel"===e?V.info("已取消操作"):V.error("取消预订失败，请稍后重试")}finally{J.value=!1}},cancelBookingFromDetail=async()=>{W.value&&(await cancelBooking(W.value),R.value=!1)},handleRefund=async a=>{try{await B.confirm("确定要申请退款吗？退款申请提交后需要管理员审核,并需要到线下退款。","申请退款",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),J.value=!0;const e=await r(a.id,{reason:"用户申请退款"});0===e.data.code?(V.success("退款申请已提交，等待管理员审核"),await fetchMyOrders()):V.error(e.message||"申请退款失败")}catch(e){"cancel"===e?V.info("已取消操作"):V.error("申请退款失败，请稍后重试")}finally{J.value=!1}};return d(()=>{fetchMyOrders()}),(a,e)=>{const t=w,l=b,o=y,r=g,u=I,i=j,n=C,d=x,B=P,Z=z,aa=A,ea=D,ta=H,la=_;return $(),c("div",O,[v("div",S,[e[7]||(e[7]=v("h2",{class:"page-title"},"我的预订记录",-1)),v("div",q,[m(r,{inline:!0,model:K.value},{default:f(()=>[m(o,{label:"预订状态"},{default:f(()=>[m(l,{modelValue:K.value.status,"onUpdate:modelValue":e[0]||(e[0]=a=>K.value.status=a),placeholder:"预订状态",clearable:"",style:{width:"120px"}},{default:f(()=>[m(t,{label:"全部",value:""}),m(t,{label:"待支付",value:"1"}),m(t,{label:"已支付",value:"2"}),m(t,{label:"已完成",value:"3"}),m(t,{label:"已取消",value:"4"}),m(t,{label:"已退款",value:"5"}),m(t,{label:"退款中",value:"6"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),p(($(),c("div",E,[0!==Q.value.length||J.value?($(),k(B,{key:1,data:Q.value,style:{width:"100%"},border:""},{default:f(()=>[m(i,{prop:"id",label:"预订号",width:"80"}),m(i,{prop:"venueName",label:"场地名称",width:"120"}),m(i,{prop:"reservationDate",label:"预订日期",width:"120"}),m(i,{prop:"timeSlot",label:"时间段",width:"120"}),m(i,{prop:"totalAmount",label:"金额(元)",width:"100"}),m(i,{prop:"status",label:"状态",width:"120"},{default:f(a=>[m(n,{type:getStatusTagType(a.row.status)},{default:f(()=>[N(T(getStatusText(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),m(i,{prop:"createTime",label:"预订时间",width:"160"}),m(i,{label:"操作",fixed:"right",width:"300"},{default:f(a=>[m(d,{type:"primary",size:"small",onClick:e=>(async a=>{try{J.value=!0;const e=await s(a.id);0===e.data.code?(W.value=e.data.data,W.value.contactName=e.data.data.remark.split(" ")[0],W.value.contactPhone=e.data.data.remark.split(" ")[1],R.value=!0):V.error(e.message||"获取订单详情失败")}catch(e){V.error("获取订单详情失败，请稍后重试")}finally{J.value=!1}})(a.row)},{default:f(()=>[...e[4]||(e[4]=[N(" 查看详情 ",-1)])]),_:1},8,["onClick"]),1===a.row.status?($(),k(d,{key:0,type:"success",size:"small",onClick:e=>(async a=>{const e=a.remark,[t,l,s]=e.split(" ");G.push({path:"/payment",query:{orderNo:a.orderNo},state:{booking:{id:a.id,venueName:a.venueName,venueId:a.venueId,reservationDate:a.reservationDate,startTime:a.startTime,endTime:a.endTime,duration:a.duration,contactName:t,contactPhone:l,remarkMessage:s,pricePerHour:a.pricePerHour,totalAmount:a.totalAmount,createTime:a.createTime}}})})(a.row)},{default:f(()=>[...e[5]||(e[5]=[N(" 立即支付 ",-1)])]),_:1},8,["onClick"])):h("",!0),1===a.row.status?($(),k(d,{key:1,type:"danger",size:"small",onClick:e=>cancelBooking(a.row),disabled:isBookingExpired(a.row)||!canCancel(a.row)},{default:f(()=>[N(T(getCancelButtonText(a.row)),1)]),_:2},1032,["onClick","disabled"])):h("",!0),2===a.row.status?($(),k(d,{key:2,type:"warning",size:"small",onClick:e=>handleRefund(a.row),disabled:2!==a.row.status},{default:f(()=>[...e[6]||(e[6]=[N(" 申请退款 ",-1)])]),_:1},8,["onClick","disabled"])):h("",!0)]),_:1})]),_:1},8,["data"])):($(),k(u,{key:0,description:"暂无预订记录"})),Q.value.length>0?($(),c("div",M,[m(Z,{background:"",layout:"prev, pager, next, total",total:F.value,"page-size":X.value,"current-page":L.value,onCurrentChange:handlePageChange},null,8,["total","page-size","current-page"])])):h("",!0)])),[[la,J.value]])]),m(ta,{title:"预订详情",modelValue:R.value,"onUpdate:modelValue":e[3]||(e[3]=a=>R.value=a),width:"500px",center:""},{footer:f(()=>[v("span",Y,[m(d,{onClick:e[1]||(e[1]=a=>R.value=!1)},{default:f(()=>[...e[8]||(e[8]=[N("关闭",-1)])]),_:1}),W.value&&canCancel(W.value)?($(),k(d,{key:0,type:"danger",onClick:cancelBookingFromDetail,disabled:isBookingExpired(W.value)||!canCancel(W.value)},{default:f(()=>[N(T(getCancelButtonText(W.value)),1)]),_:1},8,["disabled"])):h("",!0),!W.value||1!==W.value.status&&"reserved"!==W.value.status?h("",!0):($(),k(d,{key:1,type:"warning",onClick:e[2]||(e[2]=a=>handleRefund(W.value))},{default:f(()=>[...e[9]||(e[9]=[N(" 申请退款 ",-1)])]),_:1}))])]),default:f(()=>[W.value?($(),c("div",U,[m(ea,{column:1,border:!0},{default:f(()=>[m(aa,{label:"预订编号"},{default:f(()=>[N(T(W.value.id),1)]),_:1}),W.value.orderNo?($(),k(aa,{key:0,label:"订单号"},{default:f(()=>[N(T(W.value.orderNo),1)]),_:1})):h("",!0),m(aa,{label:"场地名称"},{default:f(()=>[N(T(W.value.courtName||W.value.venueName),1)]),_:1}),m(aa,{label:"预订日期"},{default:f(()=>[N(T(W.value.date||W.value.reservationDate),1)]),_:1}),m(aa,{label:"预订时段"},{default:f(()=>[N(T(W.value.timeSlot||`${W.value.startTime}-${W.value.endTime}`),1)]),_:1}),m(aa,{label:"预订价格"},{default:f(()=>[N(T(W.value.price||W.value.totalAmount)+" 元",1)]),_:1}),m(aa,{label:"预订状态"},{default:f(()=>[m(n,{type:getStatusTagType(W.value.status)},{default:f(()=>[N(T(getStatusText(W.value.status)),1)]),_:1},8,["type"])]),_:1}),m(aa,{label:"预订人"},{default:f(()=>[N(T(W.value.contactName),1)]),_:1}),m(aa,{label:"联系电话"},{default:f(()=>[N(T(W.value.contactPhone),1)]),_:1}),m(aa,{label:"预订时间"},{default:f(()=>[N(T(W.value.createTime||W.value.createdAt),1)]),_:1}),W.value.remark||W.value.note?($(),k(aa,{key:1,label:"备注"},{default:f(()=>[N(T(W.value.remark.split(" ")[2]),1)]),_:1})):h("",!0)]),_:1})])):h("",!0)]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-edab4659"]]);export{G as default};
