import{u as s,r as l,d as e,o as a,l as t,k as n,h as o,g as c,aS as i,x as r,M as d,w as m,j as p,aT as u,p as y,O as v,aU as f,aV as k,A as h,ay as w,m as _,af as C,as as x,ap as g,P as b,Q as V,an as I,E as j,a as T,Z as z,J as U,aJ as $,c as B}from"./index-RXELqIC3.js";/* empty css                    *//* empty css                 */import{_ as L}from"./_plugin-vue_export-helper-CRLhVpGU.js";/* empty css                  */import{a as M,b as P,u as H,l as J,d as Q,e as A,f as D,h as E,i as G}from"./forum-wY4xwZu6.js";/* empty css                       *//* empty css                   */import{u as K}from"./forum-Bu4C3K8F.js";import"./format-Be2yr7zd.js";const O={class:"post-detail-container"},R={key:0,class:"post-header"},S={class:"post-info"},Z={class:"author-info"},q={class:"author-detail"},F={class:"author-name"},N={class:"publish-time"},W={class:"post-meta"},X={class:"view-count"},Y={class:"delete-post"},ss={key:1,class:"post-content"},ls={class:"post-title"},es=["innerHTML"],as={class:"post-action-bar"},ts={class:"comment-section"},ns={class:"comment-title"},os={class:"comment-form"},cs={class:"comment-input-container"},is={class:"comment-actions"},rs={class:"word-count"},ds={class:"comment-sort"},ms={class:"comment-list"},ps={class:"comment-user"},us={class:"comment-content"},ys={class:"comment-header"},vs={class:"comment-author"},fs={class:"comment-time"},ks={class:"comment-text"},hs={class:"comment-footer"},ws={class:"comment-actions"},_s=["onClick"],Cs=["onClick"],xs={class:"comment-delete-wrapper"},gs=["onClick"],bs={key:0,class:"reply-form"},Vs={class:"reply-input-container"},Is={class:"reply-actions"},js={class:"reply-word-count"},Ts={class:"reply-buttons"},zs={key:1,class:"reply-list"},Us={class:"reply-user"},$s={class:"reply-content"},Bs={class:"reply-header"},Ls={class:"reply-author"},Ms={class:"reply-time"},Ps={class:"reply-text"},Hs={key:0,class:"reply-to"},Js={class:"reply-footer"},Qs={class:"reply-actions"},As=["onClick"],Ds=["onClick"],Es={class:"reply-delete-wrapper"},Gs=["onClick"],Ks={key:0,class:"reply-form nested-reply-form"},Os={class:"reply-input-container"},Rs={class:"reply-actions"},Ss={class:"reply-word-count"},Zs={class:"reply-buttons"},qs=["onClick"],Fs=L({l:"PostDetail",setup(L){const Fs=I(),Ns=T(),Ws=s(),Xs=K();l().value=Ws.userInfo;const Ys=e(()=>Xs.currentPost||{}),sl=async()=>{const s=Fs.params.id,l=await M(s);0===l.data.code?Xs.setCurrentPost(l.data.data):j.error(l.data.msg)};a(()=>{sl()});const ll=e(()=>Xs.comments||[]),el=l("time_desc"),al=l("new"),tl=async()=>{const s=Fs.params.id,l=await P(s,el.value);0===l.data.code&&Xs.setComments(l.data.data)};a(()=>{tl()});const nl=l(""),ol=e(()=>Ys.value&&void 0!==Ys.value.replyCount?Ys.value.replyCount:ll.value?ll.value.length:0),cl=l({commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}),il=l(!1),rl=l({}),dl=e(()=>ll.value?ll.value:[]),ml=e(()=>il.value?dl.value:dl.value.slice(0,3)),pl=async s=>{if(!Ws.token)return j.warning("请先登录后再点赞"),void Ns.push("/login");try{const l=Fs.params.id,e=s.id;if(s.isLiked){const a=await Q(l,e);0===a.data.code?(s.likes-=1,s.isLiked=!1,j.success("已取消点赞")):j.error(a.data.msg||"操作失败")}else{const a=await A(l,e);0===a.data.code?(s.likes+=1,s.isLiked=!0,j.success("点赞成功")):j.error(a.data.msg||"操作失败")}}catch(l){j.error("操作失败，请稍后重试")}},ul=async()=>{if(""!==nl.value.trim()){if(!Ws.token)return j.warning("请先登录后再评论"),void Ns.push("/login");try{const s=Fs.params.id,l=await G(s,{content:nl.value,parentId:null});0===l.data.code?(await tl(),await sl(),nl.value="",j.success("评论发表成功"),z().publish(`post_comment_to_${Ys.value.author}`,`${Ws.userinfo.username}评论了你的帖子`)):j.error(l.data.msg||"评论发表失败")}catch(s){j.error("评论发表失败，请稍后重试")}}else j.warning("评论内容不能为空")},yl=(s,l=null)=>{B.confirm("确定要删除这条评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=Fs.params.id,a=s.id,t=await D(e,a);if(0===t.data.code){if(l){const e=l.children.findIndex(l=>l.id===s.id);-1!==e&&l.children.splice(e,1)}else await tl();await sl(),j.success("删除成功")}else j.error(t.data.msg||"删除失败")}catch(e){j.error("删除失败，请稍后重试")}}).catch(()=>{})},vl=(s,l=null)=>{if(!Ws.token)return j.warning("请先登录后再回复"),void Ns.push("/login");let e=`回复 ${s.nickname}：`,a=null,t=null,n=s.userId;l?(a=l.id,t=s.id,n=s.userId,e=`回复 @${s.nickname}：`,rl.value={...rl.value,[l.id]:!0}):(a=s.id,t=null,n=s.userId),cl.value={commentId:a,replyId:t,replyToUserId:n,content:"",placeholder:e}},fl=()=>{cl.value={commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}},kl=async()=>{if(cl.value.content.trim())try{const s=Fs.params.id,l={content:cl.value.content,parentId:cl.value.commentId};cl.value.replyId&&(l.replyToId=cl.value.replyId),cl.value.replyToUserId&&(l.replyToUserId=cl.value.replyToUserId);const e=await G(s,l);0===e.data.code?(await tl(),await sl(),cl.value.commentId&&(rl.value={...rl.value,[cl.value.commentId]:!0}),fl(),j.success("回复成功")):j.error(e.data.msg||"回复失败")}catch(s){j.error("回复失败，请稍后重试")}else j.warning("回复内容不能为空")},hl=()=>{il.value=!il.value},wl=s=>{el.value="hot"===s?"likes":"new"===s?"time_desc":"old"===s?"time_asc":"time_desc",tl()},_l=async()=>{if(!Ws.token)return j.warning("请先登录后再点赞"),void Ns.push("/login");try{const s=Fs.params.id;if(Ys.value.isLiked){const l=await H(s);if(0===l.data.code){const s={...Ys.value,isLiked:!1,likes:Ys.value.likes-1};Xs.setCurrentPost(s),j.success("已取消点赞")}else j.error(l.data.msg||"操作失败")}else{const l=await J(s);if(0===l.data.code){const s={...Ys.value,isLiked:!0,likes:Ys.value.likes+1};Xs.setCurrentPost(s),z().publish(`post_like_to_${Ys.value.author}`,`${Ws.userinfo.username}点赞了你的帖子`),j.success("点赞成功")}else j.error(l.data.msg||"操作失败")}}catch(s){j.error("操作失败，请稍后重试")}},Cl=()=>{B.confirm("确定要删除这篇帖子吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const s=Fs.params.id,l=await E(s);0===l.data.code?(j.success("帖子删除成功"),Ns.push("/forum")):j.error(l.data.msg||"删除失败")}catch(s){j.error("删除失败，请稍后重试")}}).catch(()=>{})};return(s,l)=>{const e=i,a=y,I=_,j=C,T=x,z=g,B=k("auth");return U(),t("div",O,[Ys.value?(U(),t("div",R,[o("div",S,[o("div",Z,[c(e,{size:40,src:Ys.value.authorAvatar,class:"author-avatar"},null,8,["src"]),o("div",q,[o("div",F,r(Ys.value.author),1),o("div",N,r(Ys.value.publishTime),1)])]),o("div",W,[o("div",X,[c(a,null,{default:m(()=>[c(p(u))]),t:1}),o("span",null,r(Ys.value.views)+" 次浏览",1)]),o("div",{class:v(["like-count",{"is-liked":Ys.value.isLiked}]),onClick:_l},[c(a,null,{default:m(()=>[c(p(f))]),t:1}),o("span",null,r(Ys.value.likes)+" 点赞",1)],2),d((U(),t("div",Y,[c(I,{type:"danger",size:"small",onClick:Cl},{default:m(()=>[c(a,null,{default:m(()=>[c(p(w))]),t:1}),l[4]||(l[4]=h(" 删除帖子 ",-1))]),t:1})])),[[B,Ys.value.author]])])])])):n("",!0),Ys.value?(U(),t("div",ss,[o("h1",ls,r(Ys.value.title),1),o("div",{class:"content",innerHTML:Ys.value.content},null,8,es),o("div",as,[c(I,{type:"primary",plain:!Ys.value.isLiked,onClick:_l,class:"like-button"},{default:m(()=>[c(a,null,{default:m(()=>[c(p(f))]),t:1}),h(" "+r(Ys.value.isLiked?"已点赞":"点赞")+" "+r(Ys.value.likes),1)]),t:1},8,["plain"])])])):n("",!0),o("div",ts,[o("h3",ns,"评论 "+r(ol.value),1),o("div",os,[o("div",cs,[c(j,{modelValue:nl.value,"onUpdate:modelValue":l[0]||(l[0]=s=>nl.value=s),type:"textarea",rows:"3",placeholder:"平等表达，友善交流",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),o("div",is,[o("span",rs,r(nl.value.length)+" / 1000",1),c(I,{type:"primary",onClick:ul},{default:m(()=>[...l[5]||(l[5]=[h("发送",-1)])]),t:1})])]),o("div",ds,[c(z,{modelValue:al.value,"onUpdate:modelValue":l[1]||(l[1]=s=>al.value=s),onTabChange:wl},{default:m(()=>[c(T,{label:"最热",name:"hot"}),c(T,{label:"最新",name:"new"}),c(T,{label:"最早",name:"old"})]),t:1},8,["modelValue"])]),o("div",ms,[(U(!0),t(b,null,V(ml.value,s=>(U(),t("div",{key:s.id,class:"comment-item"},[o("div",ps,[c(e,{size:36,src:s.avatar},{default:m(()=>[h(r(s.nickname[0]),1)]),t:2},1032,["src"])]),o("div",us,[o("div",ys,[o("span",vs,r(s.nickname),1),o("span",fs,r(s.replyTime),1)]),o("div",ks,r(s.content),1),o("div",hs,[o("div",ws,[o("span",{class:v(["comment-like",{"is-liked":s.isLiked}]),onClick:l=>pl(s)},[c(a,null,{default:m(()=>[c(p($))]),t:1}),h(" 点赞 "+r(s.likes),1)],10,_s),o("span",{class:"comment-reply",onClick:l=>vl(s)},"回复",8,Cs)]),d((U(),t("div",xs,[o("span",{class:"comment-delete",onClick:l=>yl(s)},[c(a,null,{default:m(()=>[c(p(w))]),t:1}),l[6]||(l[6]=h(" 删除 ",-1))],8,gs)])),[[B,s.nickname]])]),cl.value.commentId!==s.id||cl.value.replyId?n("",!0):(U(),t("div",bs,[o("div",Vs,[c(j,{modelValue:cl.value.content,"onUpdate:modelValue":l[2]||(l[2]=s=>cl.value.content=s),type:"textarea",rows:"2",placeholder:cl.value.placeholder,maxlength:"500","show-word-limit":""},null,8,["modelValue","placeholder"])]),o("div",Is,[o("span",js,r(cl.value.content.length)+" / 500",1),o("div",Ts,[c(I,{size:"small",onClick:fl},{default:m(()=>[...l[7]||(l[7]=[h("取消",-1)])]),t:1}),c(I,{size:"small",type:"primary",onClick:kl},{default:m(()=>[...l[8]||(l[8]=[h("回复",-1)])]),t:1})])])])),s.children&&s.children.length?(U(),t("div",zs,[(U(!0),t(b,null,V(rl.value[s.id]?s.children:s.children.slice(0,3),i=>(U(),t("div",{key:i.id,class:"reply-item"},[o("div",Us,[c(e,{size:30,src:i.avatar},{default:m(()=>[h(r(i.nickname[0]),1)]),t:2},1032,["src"])]),o("div",$s,[o("div",Bs,[o("span",Ls,r(i.nickname),1),o("span",Ms,r(i.replyTime),1)]),o("div",Ps,[i.replyToNickname?(U(),t("span",Hs,"回复 @"+r(i.replyToNickname)+"：",1)):n("",!0),h(" "+r(i.content),1)]),o("div",Js,[o("div",Qs,[o("span",{class:v(["reply-like",{"is-liked":i.isLiked}]),onClick:s=>pl(i)}," 点赞 "+r(i.likes),11,As),o("span",{class:"reply-button",onClick:l=>vl(i,s)},"回复",8,Ds)]),d((U(),t("div",Es,[o("span",{class:"reply-delete",onClick:l=>yl(i,s)},[c(a,null,{default:m(()=>[c(p(w))]),t:1}),l[9]||(l[9]=h(" 删除 ",-1))],8,Gs)])),[[B,i.nickname]])]),cl.value.commentId===s.id&&cl.value.replyId===i.id?(U(),t("div",Ks,[o("div",Os,[c(j,{modelValue:cl.value.content,"onUpdate:modelValue":l[3]||(l[3]=s=>cl.value.content=s),type:"textarea",rows:"2",placeholder:cl.value.placeholder,maxlength:"500","show-word-limit":"",autofocus:""},null,8,["modelValue","placeholder"])]),o("div",Rs,[o("span",Ss,r(cl.value.content.length)+" / 500",1),o("div",Zs,[c(I,{size:"small",onClick:fl},{default:m(()=>[...l[10]||(l[10]=[h("取消",-1)])]),t:1}),c(I,{size:"small",type:"primary",onClick:kl},{default:m(()=>[...l[11]||(l[11]=[h("回复",-1)])]),t:1})])])])):n("",!0)])]))),128)),s.children.length>3?(U(),t("div",{key:0,class:"view-more-replies",onClick:l=>{return e=s.id,void(rl.value={...rl.value,[e]:!rl.value[e]});var e}},r(rl.value[s.id]?"收起回复":`查看全部 ${s.children.length} 条回复`),9,qs)):n("",!0)])):n("",!0)])]))),128)),dl.value.length>3?(U(),t("div",{key:0,class:"view-more-comments",onClick:hl},r(il.value?"收起评论":`查看全部 ${ol.value} 条评论`),1)):n("",!0)])])])}}},[["__scopeId","data-v-48021ee2"]]);export{Fs as default};
