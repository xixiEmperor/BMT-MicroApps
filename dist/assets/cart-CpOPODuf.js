import{Y as t,az as e,r,d as a,E as n}from"./index-RXELqIC3.js";function c(e,r){return t({url:`/api/cart/${e}`,method:"delete",data:r})}const u=e("cart",()=>{const e=r([]),u=r(!1),i=r(!1),o=a(()=>e.value.reduce((t,e)=>t+e.quantity,0)),s=a(()=>e.value.filter(t=>t.selected).reduce((t,e)=>t+(e.productPrice+(e.priceAdjustment||0))*e.quantity,0)),l=a(()=>e.value.filter(t=>t.selected).length);async function d(){if(!i.value){i.value=!0;try{const r=await t({url:"/api/cart",method:"get"});if(0===r.data.code)return e.value=r.data.data.cartItems||[],u.value=r.data.data.allSelected||!1,!0;throw new Error(r.data.message||"获取购物车失败")}catch(r){return n.error("获取购物车失败"),!1}finally{i.value=!1}}}async function f(e,r){if(r<=0)return await y(e);if(r>e.stock)return n.warning(`商品"${e.productName}"已达到最大库存数量(${e.stock})`),!1;try{e.quantity=r,e.totalPrice=e.productPrice*r;const a={quantity:r};return e.specificationId&&(a.specs=e.specs),await function(e,r){return t({url:`/api/cart/${e}`,method:"put",data:r})}(e.productId,a),!0}catch(a){return n.error("更新数量失败"),!1}}async function y(t){const r=e.value.findIndex(e=>t.specificationId?e.productId===t.productId&&e.specificationId===t.specificationId:e.productId===t.productId&&!e.specificationId);if(-1===r)return!1;try{e.value.splice(r,1);const a={};return t.specificationId&&(a.specs=t.specs),await c(t.productId,a),n.success("商品已从购物车中移除"),!0}catch(a){return n.error("删除商品失败"),!1}}function h(){0===e.value.length?u.value=!1:u.value=e.value.every(t=>t.selected)}return{cartItems:e,isAllSelected:u,loading:i,totalCount:o,totalPrice:s,selectedCount:l,fetchCartList:d,addToCart:async function(r){const a=void 0!==r.specificationId,c=e.value.findIndex(t=>a?t.productId===r.productId&&t.specificationId===r.specificationId:t.productId===r.productId&&!t.specificationId);try{if(c>=0){const t=e.value[c];if(t.quantity+r.quantity>t.stock)return n.warning("已达到最大库存数量"),!1;t.quantity+=r.quantity,t.totalPrice=t.productPrice*t.quantity}else e.value.push({...r,quantity:r.quantity,selected:!0,totalPrice:r.productPrice*r.quantity});const a={productId:r.productId,quantity:r.quantity};return r.specificationId&&(a.specs=r.specs),await function(e){return t({url:"/api/cart",method:"post",data:e})}(a),!0}catch(u){return n.error("添加到购物车失败"),!1}},updateItemQuantity:f,increaseQuantity:async function(t){return await f(t,t.quantity+1)},decreaseQuantity:async function(t){return await f(t,t.quantity-1)},removeFromCart:y,toggleSelectItem:async function(e){try{h();const r={selected:e.selected};return e.specificationId&&(r.specs=e.specs),await function(e,r){return t({url:`/api/cart/select/${e}`,method:"put",data:r})}(e.productId,r),!0}catch(r){return n.error("更新选择状态失败"),!1}},toggleSelectAll:async function(){try{return e.value.forEach(t=>{t.selected=u.value}),await(r=u.value,t({url:"/api/cart/select-all",method:"put",data:{selected:r}})),!0}catch(a){return n.error("更新全选状态失败"),!1}var r},clearCart:async function(){try{return e.value=[],u.value=!1,await t({url:"/api/cart",method:"delete"}),n.success("购物车已清空"),!0}catch(r){return n.error("清空购物车失败"),!1}},getSelectedItems:function(){return e.value.filter(t=>t.selected)},removeOrderedItems:async function(t){try{let a=[];if(t.product?a=[t.product]:t.products&&(a=t.products),0===a.length)return!0;let n=0,u=0;for(const t of a)try{const r=e.value.findIndex(e=>t.specificationId?e.productId===t.productId&&e.specificationId===t.specificationId:e.productId===t.productId&&!e.specificationId);if(-1!==r){e.value.splice(r,1);const a={};t.specificationId&&(a.specs=t.specs),await c(t.productId,a),n++}else n++}catch(r){u++}return h(),0===u||(await d(),!1)}catch(r){return await d(),!1}},resetLoadingState:function(){i.value=!1}}},{persist:{paths:["cartItems","isAllSelected"],afterRestore:t=>{t.store.loading=!1}}});export{u};
