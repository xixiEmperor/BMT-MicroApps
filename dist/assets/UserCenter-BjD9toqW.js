import{r as e,u as a,K as l,o as t,l as r,h as o,g as s,w as n,ah as d,ae as u,aK as i,af as c,j as p,t as m,aL as f,a0 as v,P as h,Q as g,a9 as b,q as w,aM as y,m as _,A as V,U,E as j,an as x,aN as k,a as R,aO as A,J as E,$ as F}from"./index-BtPdgGUc.js";/* empty css                *//* empty css                     */import{_ as M}from"./_plugin-vue_export-helper-CTKw_zaB.js";/* empty css                             *//* empty css                 *//* empty css                     *//* empty css               *//* empty css                  *//* empty css                    */const C={class:"user-center-container"},D=["src"],L={key:1,src:"https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png",class:"avatar",alt:"默认头像"},q={class:"form-section"},z={class:"form-section"},B=M({__name:"UserCenter",setup(M){const B=R(),I=x(),O=e("/"),$=a(),K=l({username:"",nickname:"",phone:"",bio:"",gender:"",birthday:"",location:"",avatar:""}),P=e(null),H=e(!1),J=[{value:"male",label:"男"},{value:"female",label:"女"},{value:"other",label:"其他"}],N=e(""),Q={nickname:[{pattern:/^[\u4e00-\u9fa5a-zA-Z]+$/,message:"名称只能由英文字母，汉字组成",trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}]},beforeAvatarUpload=e=>{const a="image/jpeg"===e.type||"image/png"===e.type||"image/jpg"===e.type,l=e.size/1024/1024<10;return a?!!l||(j.error("头像大小不能超过 10MB!"),!1):(j.error("文件格式不支持，请上传jpg、png或jpeg格式图片"),!1)},handleAvatarSuccess=async(e,a)=>{var l,t;if(a.raw)try{const e=await((e,a=.8)=>new Promise(l=>{const t=new FileReader;t.readAsDataURL(e),t.onload=t=>{const r=new Image;r.src=t.target.result,r.onload=()=>{const t=document.createElement("canvas"),o=t.getContext("2d");let s=r.width,n=r.height;const d=800;s>n&&s>d?(n=Math.round(n*d/s),s=d):n>d&&(s=Math.round(s*d/n),n=d),t.width=s,t.height=n,o.clearRect(0,0,s,n),o.drawImage(r,0,0,s,n),t.toBlob(a=>{const t=new File([a],e.name,{type:e.type,lastModified:Date.now()});l(t)},e.type,a)}}}))(a.raw),l=new FormData;l.append("file",e);const t=new FileReader;t.readAsDataURL(e),t.onload=()=>{N.value=t.result};const r=await A(l);if(0===r.data.code){N.value=r.data.data.avatarUrl,K.avatar=r.data.data.avatarUrl;const e={...$.userinfo,avatar:r.data.data.avatarUrl};$.setUserinfo(e),window.dispatchEvent(new CustomEvent("user-avatar-updated",{detail:{avatarUrl:r.data.data.avatarUrl}})),j.success(r.data.message||"上传成功")}else j.error(r.data.message||"上传失败")}catch(r){j.error((null==(t=null==(l=r.response)?void 0:l.data)?void 0:t.message)||"头像上传失败")}},handleAvatarChange=e=>{e.raw&&beforeAvatarUpload(e.raw)&&handleAvatarSuccess(0,e)},saveUserInfo=async()=>{try{H.value=!0,await P.value.validate();const e=await k(K);j.success(e.data.msg);const a={...$.userinfo,...e.data.data};$.setUserinfo(a),B.push(O.value)}catch(e){j.error(e.response.data.message)}finally{H.value=!1}};return t(()=>{(()=>{const e=$.userinfo;if(e)try{Object.keys(K).forEach(a=>{e[a]&&(K[a]=e[a])}),e.avatar&&(N.value=e.avatar)}catch(a){j.error(a.response.data.message)}if(I.query.from)O.value=I.query.from;else if(document.referrer&&document.referrer.includes(window.location.origin)){const e=new URL(document.referrer);O.value=e.pathname+e.search}})()}),(e,a)=>{const l=i,t=u,j=c,x=F,k=v,R=b,A=_,M=d,B=U;return E(),r("div",C,[a[11]||(a[11]=o("h2",null,"个人中心",-1)),s(B,{class:"user-center-card"},{default:n(()=>[s(M,{ref_key:"userFormRef",ref:P,model:K,rules:Q,"label-position":"top",class:"user-form"},{default:n(()=>[s(t,{class:"avatar-uploader-container"},{default:n(()=>[s(l,{class:"avatar-uploader","show-file-list":!1,"on-change":handleAvatarChange,"before-upload":beforeAvatarUpload,"auto-upload":!1,name:"file"},{default:n(()=>[N.value?(E(),r("img",{key:0,src:N.value,class:"avatar"},null,8,D)):(E(),r("img",L)),a[7]||(a[7]=o("div",{class:"avatar-hover-text"},"点击更换头像",-1))]),_:1})]),_:1}),o("div",q,[a[8]||(a[8]=o("h3",null,"基本信息",-1)),s(t,{label:"账号"},{default:n(()=>[s(j,{modelValue:K.username,"onUpdate:modelValue":a[0]||(a[0]=e=>K.username=e),disabled:"",placeholder:"userinfo.username"},null,8,["modelValue"])]),_:1}),s(t,{label:"昵称",prop:"nickname"},{default:n(()=>[s(j,{modelValue:K.nickname,"onUpdate:modelValue":a[1]||(a[1]=e=>K.nickname=e),placeholder:"请输入昵称","prefix-icon":p(m)},null,8,["modelValue","prefix-icon"])]),_:1}),s(t,{label:"手机号码",prop:"phone"},{default:n(()=>[s(j,{modelValue:K.phone,"onUpdate:modelValue":a[2]||(a[2]=e=>K.phone=e),placeholder:"请输入手机号码","prefix-icon":p(f)},null,8,["modelValue","prefix-icon"])]),_:1}),s(t,{label:"个人简介"},{default:n(()=>[s(j,{modelValue:K.bio,"onUpdate:modelValue":a[3]||(a[3]=e=>K.bio=e),type:"textarea",placeholder:"请输入个人简介",rows:4},null,8,["modelValue"])]),_:1})]),o("div",z,[a[9]||(a[9]=o("h3",null,"更多信息",-1)),s(t,{label:"性别"},{default:n(()=>[s(k,{modelValue:K.gender,"onUpdate:modelValue":a[4]||(a[4]=e=>K.gender=e),placeholder:"请选择性别",style:{width:"100%"}},{default:n(()=>[(E(),r(h,null,g(J,e=>s(x,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),s(t,{label:"生日"},{default:n(()=>[s(R,{modelValue:K.birthday,"onUpdate:modelValue":a[5]||(a[5]=e=>K.birthday=e),type:"date",placeholder:"请选择生日",style:{width:"100%"},"prefix-icon":p(w)},null,8,["modelValue","prefix-icon"])]),_:1}),s(t,{label:"所在地"},{default:n(()=>[s(j,{modelValue:K.location,"onUpdate:modelValue":a[6]||(a[6]=e=>K.location=e),placeholder:"请输入所在地","prefix-icon":p(y)},null,8,["modelValue","prefix-icon"])]),_:1})]),s(t,null,{default:n(()=>[s(A,{type:"primary",onClick:saveUserInfo,loading:H.value,class:"save-btn"},{default:n(()=>[...a[10]||(a[10]=[V("保存修改",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})])}}},[["__scopeId","data-v-1c0e85da"]]);export{B as default};
